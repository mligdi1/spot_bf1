{% extends 'editorial/base.html' %}
{% block title %}Notifications Rédaction{% endblock %}
{% block content %}
<div class="space-y-6">
  <!-- En-tête -->
  <section class="relative overflow-hidden rounded-2xl ed-card text-white border border-black border-opacity-20 shadow-lg" style="background:linear-gradient(90deg,#E53E3E 0%,#C53030 100%);">
    <div class="absolute inset-0" style="background:radial-gradient(1200px 400px at 10% 0%, rgba(0,0,0,0.20) 0%, rgba(0,0,0,0.0) 60%)"></div>
    <div class="absolute inset-0" style="background:radial-gradient(800px 300px at 90% 100%, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0) 60%)"></div>
    <div class="relative z-10 p-8 flex items-start justify-between">
      <div>
        <div class="flex items-center gap-3" style="text-shadow:0 1px 2px rgba(0,0,0,0.25)">
          <i class="fa-solid fa-bell text-white text-2xl"></i>
          <div class="font-montserrat text-3xl md:text-4xl font-extrabold">Notifications</div>
        </div>
        <div class="mt-2 text-white text-opacity-90" style="text-shadow:0 1px 1px rgba(0,0,0,0.25)">
          Couvertures validées par l'administration — BF1 TV
        </div>
      </div>
      <a href="{% url 'editorial_dashboard' %}" class="px-6 py-3 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl">
        <i class="fa-solid fa-arrow-left mr-2"></i>Retour
      </a>
    </div>
  </section>

  <!-- Filtres et Actions -->
  <div class="bg-white ed-card p-4 flex flex-wrap items-end justify-between gap-4">
    <form method="GET" class="grid grid-cols-12 gap-3 items-end">
      <div class="col-span-12 sm:col-span-4">
        <label class="text-xs font-medium text-slate-600">Type</label>
        <select name="type" class="mt-1 w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-red-200 focus:border-red-300" onchange="this.form.submit()">
          <option value="">Tous les types</option>
          <option value="success" {% if request.GET.type == 'success' %}selected{% endif %}>Succès</option>
          <option value="warning" {% if request.GET.type == 'warning' %}selected{% endif %}>Avertissement</option>
          <option value="info" {% if request.GET.type == 'info' %}selected{% endif %}>Info</option>
        </select>
      </div>
      <div class="col-span-12 sm:col-span-4">
        <label class="text-xs font-medium text-slate-600">Date</label>
        <input type="date" name="date" value="{{ request.GET.date }}" class="mt-1 w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-red-200 focus:border-red-300" onchange="this.form.submit()">
      </div>
      <div class="col-span-12 sm:col-span-4 flex items-center justify-end gap-3">
        <a href="?" class="btn btn--outline px-4 py-2 text-sm">Réinitialiser</a>
        <button id="mark_all_read" type="button" class="btn btn--primary px-4 py-2 text-sm">
          <i class="fa-solid fa-check-double mr-2"></i>Tout marquer comme lu
        </button>
      </div>
    </form>
  </div>

  <!-- Liste des notifications -->
  <div class="bg-white ed-card p-6 shadow-sm">
    {% if items %}
      <div class="mb-4 flex items-center justify-between">
        <div class="text-sm text-gray-600">
          <span class="font-semibold text-gray-900">{{ items|length }}</span> notification{{ items|length|pluralize }}
        </div>
      </div>
      
      <div class="space-y-3">
        {% for n in items %}
          {% ifchanged n.created_at|date:'d/m/Y' %}
            <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3 mt-6 first:mt-0">
              {{ n.created_at|date:'l d F Y'|capfirst }}
            </div>
          {% endifchanged %}
          
          <div class="js-ed-notif-item group border border-gray-200 rounded-xl p-5 hover:shadow-md hover:border-red-200 transition-all duration-200 {% if not n.is_read %}bg-red-50 bg-opacity-30 border-red-200{% else %}bg-white{% endif %}" data-id="{{ n.id }}" data-is-read="{% if n.is_read %}1{% else %}0{% endif %}">
            <div class="flex items-start gap-4">
              <div class="flex-shrink-0">
                <div class="w-12 h-12 rounded-full {% if not n.is_read %}bg-red-100{% else %}bg-gray-100{% endif %} flex items-center justify-center">
                  {% if n.type == 'success' %}
                    <i class="fa-solid fa-check-circle text-green-600 text-xl"></i>
                  {% elif n.type == 'error' %}
                    <i class="fa-solid fa-exclamation-circle text-red-600 text-xl"></i>
                  {% elif n.type == 'warning' %}
                    <i class="fa-solid fa-exclamation-triangle text-yellow-600 text-xl"></i>
                  {% else %}
                    <i class="fa-solid fa-info-circle {% if not n.is_read %}text-red-600{% else %}text-gray-600{% endif %} text-xl"></i>
                  {% endif %}
                </div>
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-3 mb-2">
                  <div>
                    <h3 class="font-semibold text-gray-900 mb-1 {% if not n.is_read %}text-lg{% endif %}">
                      {{ n.title }}
                    </h3>
                    <p class="text-sm text-gray-600 leading-relaxed">
                      {{ n.message }}
                    </p>
                  </div>
                  <div class="flex items-center gap-2">
                    {% if not n.is_read %}
                      <span class="flex-shrink-0 w-2 h-2 rounded-full bg-red-600"></span>
                    {% endif %}
                    <button class="text-gray-400 hover:text-red-600 transition-colors action-btn" data-action="delete" data-id="{{ n.id }}" title="Archiver/Supprimer">
                        <i class="fa-solid fa-times"></i>
                    </button>
                  </div>
                </div>
                <div class="flex items-center gap-4 mt-3">
                  <span class="text-xs text-gray-500">
                    <i class="fa-solid fa-clock mr-1"></i>{{ n.created_at|date:'H:i' }}
                  </span>
                  {% if n.related_coverage %}
                    <a href="{% url 'editorial_coverage_detail' n.related_coverage.id %}" 
                       class="inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-medium bg-red-600 hover:bg-red-700 text-white transition-all shadow-sm hover:shadow-md">
                      <i class="fa-solid fa-eye mr-1.5"></i>Voir la couverture
                    </a>
                  {% elif n.related_thread %}
                    <a href="{% url 'editorial_chat_thread' n.related_thread.id %}"
                       class="inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-900 hover:bg-gray-800 text-white transition-all shadow-sm hover:shadow-md">
                      <i class="fa-solid fa-comments mr-1.5"></i>Voir la discussion
                    </a>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center py-16">
        <div class="mx-auto w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center mb-6">
          <i class="fa-solid fa-bell-slash text-gray-400 text-4xl"></i>
        </div>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">
          Aucune notification
        </h3>
        <p class="text-gray-600 mb-6 max-w-md mx-auto">
          Vous n'avez pas encore de notifications concernant les couvertures validées par l'administration.
        </p>
        <a href="{% url 'editorial_dashboard' %}" class="inline-flex items-center px-6 py-3 rounded-lg bg-red-600 hover:bg-red-700 text-white font-medium transition-all shadow-md hover:shadow-lg">
          <i class="fa-solid fa-arrow-left mr-2"></i>Retour au dashboard
        </a>
      </div>
    {% endif %}
  </div>
</div>

<script>
(function(){
    function csrftoken(){
      const name = 'csrftoken';
      const cookies = document.cookie ? document.cookie.split(';') : [];
      for (let c of cookies){
        const k = c.trim();
        if (k.startsWith(name + '=')) return decodeURIComponent(k.split('=')[1]);
      }
      return '';
    }

    const actionBtns = document.querySelectorAll('.action-btn');
    actionBtns.forEach(btn => {
        btn.addEventListener('click', async function(e){
            e.preventDefault();
            const action = this.dataset.action;
            const id = this.dataset.id;
            await performAction(action, id, this);
        });
    });

    document.getElementById('mark_all_read')?.addEventListener('click', async function(){
        if(confirm('Tout marquer comme lu ?')){
            const ok = await performAction('mark_read', null, null);
            if(ok) location.reload();
        }
    });

    async function performAction(action, id, el){
        const fd = new FormData();
        fd.append('action', action);
        if(id) fd.append('id', id);

        try{
          const r = await fetch('', {
            method: 'POST',
            body: fd,
            headers: {'X-Requested-With':'XMLHttpRequest','X-CSRFToken': csrftoken()}
          });
          const res = await r.json();
          if(!res.ok) return false;
          if(action === 'delete' && el){
            el.closest('.group').remove();
            return true;
          }
          return true;
        }catch(e){
          return false;
        }
    }

    const listRoot = document.querySelector('.js-ed-notif-item')?.parentElement;
    if(listRoot){
      listRoot.addEventListener('click', async function(e){
        const card = e.target.closest('.js-ed-notif-item');
        if(!card || !listRoot.contains(card)) return;
        if(e.target.closest('.action-btn')) return;
        if(card.getAttribute('data-is-read') === '1') return;

        const id = card.getAttribute('data-id');
        const link = e.target.closest('a[href]');
        if(link){
          e.preventDefault();
          await performAction('mark_read', id, null);
          const href = link.getAttribute('href');
          if(href) window.location.href = href;
          return;
        }

        const ok = await performAction('mark_read', id, null);
        if(ok) location.reload();
      });
    }
})();
</script>
{% endblock %}

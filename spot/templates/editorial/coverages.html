{% extends 'editorial/base.html' %}
{% block title %}Demandes de couverture{% endblock %}
{% block content %}
<div class="space-y-6">
  <section class="relative overflow-hidden rounded-2xl ed-card text-white border border-black border-opacity-20 shadow-lg" style="background:linear-gradient(90deg,#FF0000 0%,#D00000 100%);">
    <div class="absolute inset-0" style="background:radial-gradient(1200px 400px at 10% 0%, rgba(0,0,0,0.20) 0%, rgba(0,0,0,0.0) 60%)"></div>
    <div class="absolute inset-0" style="background:radial-gradient(800px 300px at 90% 100%, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0) 60%)"></div>
    <div class="relative z-10 p-8 flex items-start justify-between">
      <div>
        <div class="flex items-center gap-3" style="text-shadow:0 1px 2px rgba(0,0,0,0.25)">
          <i class="fa-solid fa-newspaper text-white text-2xl"></i>
          <div class="font-montserrat text-3xl md:text-4xl font-extrabold">Demandes de couverture</div>
        </div>
        <div class="mt-2 text-white text-opacity-90" style="text-shadow:0 1px 1px rgba(0,0,0,0.25)">Pilotage premium ‚Äî BF1 TV</div>
      </div>
      <a href="{% url 'editorial_dashboard' %}" class="px-4 py-2 rounded-lg border border-white border-opacity-50 text-white hover:bg-white hover:bg-opacity-10 transition">Retour dashboard</a>
    </div>
  </section>

  {% if inbox_items %}
  <section class="rounded-2xl ed-card p-6 border border-slate-300 bg-white text-slate-900">
    <div class="flex items-start justify-between">
      <div class="flex items-center gap-3">
        <span class="text-2xl">üì•</span>
        <div>
          <div class="font-montserrat text-xl font-extrabold">Inbox / demandes</div>
          <div class="text-slate-600">Couvertures non assign√©es</div>
        </div>
      </div>
      <span class="px-3 py-1 rounded-full bg-slate-100 text-slate-700">En attente</span>
    </div>
    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      {% for cv in inbox_items %}
        <div class="bg-white text-slate-900 rounded-xl p-4 shadow-sm">
          <div class="flex items-start justify-between">
            <div>
              <div class="font-semibold">{{ cv.event_title }}</div>
              <div class="text-sm text-slate-600">{{ cv.address }}{% if cv.event_date %} ‚Ä¢ {{ cv.event_date|date:'d/m/Y' }}{% endif %}</div>
              <div class="text-xs text-slate-500 mt-1">Cr√©√©e le {{ cv.created_at|date:'d/m/Y H:i' }}</div>
              <div class="text-xs text-slate-500 mt-1">{{ cv.get_coverage_type_display }}{% if cv.get_urgency_level_display %} ‚Ä¢ {{ cv.get_urgency_level_display }}{% endif %}</div>
            </div>
            <span class="px-2 py-1 rounded-full text-xs bg-orange-100 text-orange-800">Non assign√©e</span>
          </div>
        </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <div class="bg-white card p-4 sticky top-4 z-10">
    <form id="cv-filter" method="get" class="grid grid-cols-12 gap-3">
      <div class="col-span-12 md:col-span-5 form__group">
        <input id="filter-q" type="text" name="q" value="{{ q }}" placeholder="Rechercher..." class="form__control"/>
        <label for="filter-q" class="form__label">Rechercher</label>
      </div>
      <div class="col-span-12 md:col-span-3 form__group form__group--static">
        <select id="filter-status" name="status" class="form__control">
          <option value="">Tous statuts</option>
          <option value="new" {% if status == 'new' %}selected{% endif %}>Nouveau</option>
          <option value="review" {% if status == 'review' %}selected{% endif %}>En attente</option>
          <option value="scheduled" {% if status == 'scheduled' %}selected{% endif %}>Valid√©</option>
          <option value="closed" {% if status == 'closed' %}selected{% endif %}>Termin√©</option>
        </select>
        <label for="filter-status" class="form__label">Statut</label>
      </div>
      <div class="col-span-12 md:col-span-2 form__group form__group--static">
        <select id="filter-sort" name="sort" class="form__control">
          <option value="date_desc" {% if sort == 'date_desc' %}selected{% endif %}>Date d√©croissante</option>
          <option value="date_asc" {% if sort == 'date_asc' %}selected{% endif %}>Date croissante</option>
        </select>
        <label for="filter-sort" class="form__label">Tri</label>
      </div>
      <button class="col-span-12 md:col-span-2 btn btn--primary">Filtrer</button>
    </form>
    <div class="mt-4 flex items-center gap-3 text-xs">
      <span class="px-2 py-1 rounded-full bg-yellow-100 text-yellow-800">Nouveau {{ counts.new|default:0 }}</span>
      <span class="px-2 py-1 rounded-full bg-blue-100 text-blue-800">En attente {{ counts.review|default:0 }}</span>
      <span class="px-2 py-1 rounded-full bg-green-100 text-green-800">Valid√© {{ counts.scheduled|default:0 }}</span>
      <span class="px-2 py-1 rounded-full bg-purple-100 text-purple-800">En mission {{ counts.in_mission|default:0 }}</span>
      <span class="px-2 py-1 rounded-full bg-gray-100 text-gray-800">Termin√© {{ counts.closed|default:0 }}</span>
    </div>
  </div>

  <script>
    (function(){
      document.querySelectorAll('form[data-assign]').forEach(function(form){
        form.addEventListener('submit', function(ev){
          ev.preventDefault();
          var url=form.getAttribute('action');
          var fd=new FormData(form);
          fd.append('ajax','1');
          var token=form.querySelector('input[name="csrfmiddlewaretoken"]').value;
          fetch(url, {method:'POST', headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':token}, body:fd}).then(function(r){return r.json()}).then(function(json){
            if(json && json.ok){
              var card=form.closest('.bg-white');
              if(card){ card.style.transition='opacity 200ms ease, transform 200ms ease'; card.style.opacity='0'; card.style.transform='translateY(6px)'; setTimeout(function(){ card.remove(); }, 220); }
            }
          }).catch(function(){ /* noop */ });
        });
      });
    })();
  </script>

  <section aria-labelledby="valid-list">
    <div class="flex items-center justify-between mb-3">
      <h2 id="valid-list" class="text-xl font-semibold">Demandes valid√©es</h2>
      <div class="text-sm text-slate-600">Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</div>
    </div>

    <div id="cv-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 relative">
      <div id="cv-loading" class="hidden absolute inset-0 bg-white bg-opacity-70 backdrop-blur-sm flex items-center justify-center z-10">
        <div class="animate-spin h-8 w-8 rounded-full border-2 border-red-600 border-t-transparent"></div>
      </div>
      {% for cv in page_obj.object_list %}
        <a href="{% url 'editorial_coverage_detail' cv.id %}" class="block border rounded-xl p-4 hover:border-red-600 bg-white card transition-transform duration-200 transform hover:-translate-y-0.5" aria-label="Ouvrir la demande">
          <div class="flex items-start justify-between">
            <div>
              <div class="font-semibold">{{ cv.event_title }}</div>
              <div class="text-sm text-slate-600">{{ cv.address }}{% if cv.event_date %} ‚Ä¢ {{ cv.event_date|date:'d/m/Y' }}{% endif %}</div>
              <div class="text-xs text-slate-500 mt-1">{{ cv.get_coverage_type_display }}</div>
            </div>
            <span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-800">Valid√©</span>
          </div>
          <div class="mt-3 text-sm">Contact: {{ cv.contact_name|default:'-' }}</div>
        </a>
      {% empty %}
        <div class="text-slate-600">Aucune demande valid√©e pour le moment.</div>
      {% endfor %}
    </div>

    {% if page_obj.paginator.num_pages > 1 %}
      <div id="cv-pagination" class="mt-4 flex items-center justify-between">
        {% if page_obj.has_previous %}
          <a href="?status={{ status }}&sort={{ sort }}&q={{ q }}&page={{ page_obj.previous_page_number }}" class="px-3 py-2 border rounded hover:bg-gray-50" data-page="{{ page_obj.previous_page_number }}">Pr√©c√©dent</a>
        {% else %}
          <span class="px-3 py-2 border rounded text-slate-400">Pr√©c√©dent</span>
        {% endif %}
        <div class="text-sm">Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</div>
        {% if page_obj.has_next %}
          <a href="?status={{ status }}&sort={{ sort }}&q={{ q }}&page={{ page_obj.next_page_number }}" class="px-3 py-2 border rounded hover:bg-gray-50" data-page="{{ page_obj.next_page_number }}">Suivant</a>
        {% else %}
          <span class="px-3 py-2 border rounded text-slate-400">Suivant</span>
        {% endif %}
      </div>
    {% endif %}
  </section>

  <script>
    (function(){
      var list = document.getElementById('cv-list');
      var loader = document.getElementById('cv-loading');
      var pag = document.getElementById('cv-pagination');
      function showLoader(show){ if(!loader) return; loader.classList[show?'remove':'add']('hidden'); }
      function cardHtml(item){
        var d = item.event_date ? new Date(item.event_date) : null;
        var dateTxt = d ? d.toLocaleDateString() : '';
        return (
          '<a href="'+item.detail_url+'" class="block border rounded-xl p-4 hover:border-red-600 bg-white card transition-transform duration-200 transform hover:-translate-y-0.5" aria-label="Ouvrir la demande">\n'
          + '  <div class="flex items-start justify-between">\n'
          + '    <div>\n'
          + '      <div class="font-semibold">'+(item.event_title||'')+'</div>\n'
          + '      <div class="text-sm text-slate-600">'+(item.address||'')+(dateTxt?(' ‚Ä¢ '+dateTxt):'')+'</div>\n'
          + '      <div class="text-xs text-slate-500 mt-1">'+(item.coverage_type||'')+'</div>\n'
          + '    </div>\n'
          + '    <span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-800">Valid√©</span>\n'
          + '  </div>\n'
          + '  <div class="mt-3 text-sm">Contact: '+(item.contact_name||'-')+'</div>\n'
          + '</a>'
        );
      }
      function fetchPage(page){
        showLoader(true);
        var params = new URLSearchParams(window.location.search);
        params.set('page', page);
        params.set('format','json');
        fetch(window.location.pathname + '?' + params.toString(), {headers:{'X-Requested-With':'XMLHttpRequest'}})
          .then(function(r){ return r.json(); })
          .then(function(data){
            if(!data || !data.ok) return;
            var html = '';
            data.items.forEach(function(it){ html += cardHtml(it); });
            list.innerHTML = html || '<div class="text-slate-600">Aucune demande valid√©e pour le moment.</div>';
            if(pag){
              var phtml = '';
              phtml += (data.pagination.has_prev ? ('<a href="?page='+(data.pagination.page-1)+'" class="px-3 py-2 border rounded hover:bg-gray-50" data-page="'+(data.pagination.page-1)+'">Pr√©c√©dent</a>') : '<span class="px-3 py-2 border rounded text-slate-400">Pr√©c√©dent</span>');
              phtml += '<div class="text-sm">Page '+data.pagination.page+' / '+data.pagination.num_pages+'</div>';
              phtml += (data.pagination.has_next ? ('<a href="?page='+(data.pagination.page+1)+'" class="px-3 py-2 border rounded hover:bg-gray-50" data-page="'+(data.pagination.page+1)+'">Suivant</a>') : '<span class="px-3 py-2 border rounded text-slate-400">Suivant</span>');
              pag.innerHTML = phtml;
            }
            history.replaceState(null,'', window.location.pathname + '?' + params.toString());
          })
          .catch(function(){ /* no-op */ })
          .finally(function(){ showLoader(false); bindPagination(); });
      }
      function bindPagination(){
        if(!pag) return;
        pag.querySelectorAll('a[data-page]').forEach(function(a){
          a.addEventListener('click', function(e){ e.preventDefault(); var p = this.getAttribute('data-page'); fetchPage(p); });
        });
      }
      var filterForm = document.getElementById('cv-filter');
      if(filterForm){ filterForm.addEventListener('submit', function(e){ e.preventDefault(); fetchPage(1); }); }
      bindPagination();
    })();
  </script>
</div>
{% endblock %}

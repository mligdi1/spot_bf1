{% extends 'editorial/base.html' %}
{% block title %}Demande de couverture{% endblock %}
{% block content %}
<div class="space-y-6">
  <section class="relative overflow-hidden rounded-2xl ed-card text-white border border-black border-opacity-20 shadow-lg" style="background:linear-gradient(90deg,#FF0000 0%,#D00000 100%);">
    <div class="absolute inset-0" style="background:radial-gradient(1200px 400px at 10% 0%, rgba(0,0,0,0.20) 0%, rgba(0,0,0,0.0) 60%)"></div>
    <div class="absolute inset-0" style="background:radial-gradient(800px 300px at 90% 100%, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0) 60%)"></div>
    <div class="relative z-10 p-8">
      <div class="flex items-start justify-between">
        <div>
          <div class="font-montserrat text-3xl md:text-4xl font-extrabold" style="text-shadow:0 1px 2px rgba(0,0,0,0.25)">{{ coverage.event_title }}</div>
          <div class="mt-2 text-white" style="text-shadow:0 1px 1px rgba(0,0,0,0.25)">{{ coverage.address }} · {{ coverage.event_date|date:'d/m/Y' }}{% if coverage.start_time %} · {{ coverage.start_time|time:'H:i' }}{% endif %}</div>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-sm px-3 py-1 rounded-full border border-white border-opacity-50 bg-white bg-opacity-10">{{ coverage.get_coverage_type_display }}</span>
          <span class="text-sm px-3 py-1 rounded-full border border-white border-opacity-50 bg-white bg-opacity-10">{{ coverage.get_urgency_level_display }}</span>
        </div>
      </div>
    </div>
  </section>

  <div class="grid grid-cols-12 gap-6">
    <section class="col-span-12 bg-white ed-card p-6">
      <div class="flex items-center gap-3 text-sm">
        <a href="#apercu" class="px-3 py-1 rounded bg-slate-100">Aperçu</a>
        <a href="#assignation" class="px-3 py-1 rounded bg-slate-100">Assignation</a>
      </div>
    </section>

    <section id="apercu" class="col-span-12 lg:col-span-8 bg-white ed-card p-6">
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div>
          <div class="text-slate-500">Statut</div>
          <div class="font-medium">{{ coverage.get_status_display }}</div>
        </div>
        <div>
          <div class="text-slate-500">Urgence</div>
          <div class="font-medium">{{ coverage.get_urgency_level_display }}</div>
        </div>
      </div>
      <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="border rounded-xl p-4">
          <div class="text-lg font-semibold mb-2">Événement</div>
          <div class="text-sm space-y-2">
            <div><span class="text-slate-500">Type</span> · <span class="font-medium">{{ coverage.get_event_type_display }}{% if coverage.event_type == 'other' and coverage.event_type_other %} · {{ coverage.event_type_other }}{% endif %}</span></div>
            <div><span class="text-slate-500">Date</span> · <span class="font-medium">{{ coverage.event_date|date:'d/m/Y' }}</span></div>
            <div><span class="text-slate-500">Horaire</span> · <span class="font-medium">{% if coverage.start_time %}{{ coverage.start_time|time:'H:i' }}{% else %}—{% endif %}{% if coverage.end_time %} – {{ coverage.end_time|time:'H:i' }}{% endif %}</span></div>
            <div><span class="text-slate-500">Adresse</span> · <span class="font-medium">{{ coverage.address }}</span></div>
            {% if coverage.meeting_point %}
            <div><span class="text-slate-500">Point de rencontre</span> · <span class="font-medium">{{ coverage.meeting_point }}</span></div>
            {% endif %}
          </div>
          {% if coverage.description %}
          <div class="mt-3 text-sm">
            <div class="text-slate-500">Description</div>
            <div class="mt-1">{{ coverage.description }}</div>
          </div>
          {% endif %}
        </div>
        <div class="border rounded-xl p-4">
          <div class="text-lg font-semibold mb-2">Contacts</div>
          <div class="text-sm space-y-2">
            <div><span class="text-slate-500">Contact principal</span> · <span class="font-medium">{{ coverage.contact_name|default:'-' }}{% if coverage.contact_phone %} · {{ coverage.contact_phone }}{% endif %}{% if coverage.contact_email %} · {{ coverage.contact_email }}{% endif %}</span></div>
            {% if coverage.other_contacts %}
            <div><span class="text-slate-500">Autres contacts</span> · <span class="font-medium">{{ coverage.other_contacts }}</span></div>
            {% endif %}
          </div>
          <div class="mt-4 text-sm">
            <div class="text-slate-500">Pièces jointes</div>
            {% if coverage.attachments.all %}
              <ul class="divide-y mt-2">
                {% for att in coverage.attachments.all %}
                  <li class="py-2"><a href="{{ att.file.url }}" class="text-red-600 hover:text-red-700">{{ att.file.name }}</a> <span class="text-xs text-slate-500">{{ att.uploaded_at|date:'d/m/Y H:i' }}</span></li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="text-slate-600">Aucune pièce jointe.</div>
            {% endif %}
          </div>
        </div>
        <div class="md:col-span-2 border rounded-xl p-4">
          <div class="text-lg font-semibold mb-2">Couverture</div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div>
              <div class="text-slate-500">Type de couverture</div>
              <div class="font-medium">{{ coverage.get_coverage_type_display }}</div>
            </div>
            <div>
              <div class="text-slate-500">Réponse attendue avant</div>
              <div class="font-medium">{% if coverage.response_deadline %}{{ coverage.response_deadline|date:'d/m/Y' }}{% else %}—{% endif %}</div>
            </div>
            <div class="md:col-span-2">
              <div class="text-slate-500">Objectif de la couverture</div>
              <div class="mt-1">{% if coverage.coverage_objective %}{{ coverage.coverage_objective }}{% else %}—{% endif %}</div>
            </div>
            <div>
              <div class="text-slate-500">Informations confirmées</div>
              <div class="font-medium">{% if coverage.confirm_info %}Oui{% else %}Non{% endif %}</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="assignation" class="col-span-12 lg:col-span-4 bg-white card p-6">
      <div class="text-xl font-semibold mb-4">Équipe assignée</div>
      <div class="space-y-4">
        <div>
          <div class="text-sm text-slate-500 mb-2">Journalistes</div>
          {% if assigned_journalists %}
            <div class="space-y-2">
              {% for j in assigned_journalists %}
                <div class="border rounded-xl p-3 flex items-center gap-3">
                  {% if j.photo %}
                    <img src="{{ j.photo.url }}" alt="{{ j.name }}" class="w-10 h-10 rounded-full object-cover" />
                  {% else %}
                    <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-600 text-sm">{{ j.name|slice:':1'|upper }}</div>
                  {% endif %}
                  <div>
                    <div class="font-medium">{{ j.name }}</div>
                    <div class="text-xs text-slate-500">{% if j.phone %}{{ j.phone }}{% else %}—{% endif %}</div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-sm text-slate-600">—</div>
          {% endif %}
        </div>

        <div>
          <div class="text-sm text-slate-500 mb-2">Chauffeurs</div>
          {% if assigned_drivers %}
            <div class="space-y-2">
              {% for d in assigned_drivers %}
                <div class="border rounded-xl p-3 flex items-center gap-3">
                  {% if d.photo %}
                    <img src="{{ d.photo.url }}" alt="{{ d.name }}" class="w-10 h-10 rounded-full object-cover" />
                  {% else %}
                    <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-600 text-sm">{{ d.name|slice:':1'|upper }}</div>
                  {% endif %}
                  <div>
                    <div class="font-medium">{{ d.name }}</div>
                    <div class="text-xs text-slate-500">{% if d.phone %}{{ d.phone }}{% else %}—{% endif %}</div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-sm text-slate-600">—</div>
          {% endif %}
        </div>
      </div>

      <div class="mt-6 border rounded-xl p-4">
        <div class="text-lg font-semibold mb-2">Notifications</div>
        {% if assignments %}
          <div class="space-y-3">
            {% for a in assignments %}
              <div class="border rounded-xl p-3">
                <div class="font-medium text-sm">
                  {% if a.journalist %}Journaliste: {{ a.journalist.name }}{% endif %}
                  {% if a.driver %}Chauffeur: {{ a.driver.name }}{% endif %}
                </div>
                <div class="mt-2 space-y-3">
                  {% for c in a.notification_campaigns.all %}
                    <div class="border rounded-xl p-3">
                      <div class="flex items-start justify-between gap-3">
                        <div>
                          <div class="font-medium">{{ c.get_recipient_kind_display }}</div>
                          <div class="text-xs text-slate-500">
                            {% if c.to_email %}Email: {{ c.to_email }}{% endif %}
                            {% if c.to_email and c.to_phone %} · {% endif %}
                            {% if c.to_phone %}Tél: {{ c.to_phone }}{% endif %}
                          </div>
                        </div>
                        <div class="text-right">
                          <div class="text-xs px-2 py-1 rounded-full border bg-slate-50 text-slate-700 inline-block">{{ c.get_status_display }}</div>
                          {% if c.confirmed_at %}
                            <div class="text-xs text-slate-500 mt-1">Notifiée le {{ c.confirmed_at|date:'d/m/Y H:i' }}</div>
                          {% endif %}
                        </div>
                      </div>

                      <div class="mt-3 flex flex-wrap gap-2">
                        <a class="btn btn--outline px-3 py-2 text-sm" href="{% url 'assignment_pdf' c.id c.confirm_code %}" target="_blank" rel="noopener">Télécharger PDF</a>
                        {% if c.to_phone %}
                          <form method="post" action="{% url 'assignment_notify_whatsapp' c.id %}">
                            {% csrf_token %}
                            <button class="btn btn--outline px-3 py-2 text-sm" type="submit">Notifier par WhatsApp</button>
                          </form>
                        {% endif %}
                        {% if c.to_email %}
                          <form method="post" action="{% url 'assignment_notify_email' c.id %}">
                            {% csrf_token %}
                            <button class="btn btn--outline px-3 py-2 text-sm" type="submit">Notifier par email</button>
                          </form>
                        {% endif %}
                      </div>

                      {% if c.attempts.all %}
                        <div class="mt-3 space-y-2">
                          {% for t in c.attempts.all %}
                            <div class="border rounded-lg p-2">
                              <div class="flex items-start justify-between gap-3 text-xs">
                                <div>
                                  <span class="px-2 py-0.5 rounded-full border bg-white">{{ t.get_channel_display }}</span>
                                  <span class="ml-2 px-2 py-0.5 rounded-full border bg-slate-50 text-slate-700">{{ t.get_status_display }}</span>
                                  {% if t.to %}<span class="ml-2 text-slate-500">{{ t.to }}</span>{% endif %}
                                </div>
                                <div class="text-slate-500">{{ t.created_at|date:'d/m/Y H:i' }}</div>
                              </div>
                              {% if t.channel == 'whatsapp' and t.meta.link %}
                                <div class="mt-2 text-xs">
                                  <a class="text-red-600 hover:text-red-700 underline" href="{{ t.meta.link }}" target="_blank" rel="noopener">Ouvrir WhatsApp</a>
                                </div>
                              {% endif %}
                              {% if t.error %}
                                <div class="mt-2 text-xs text-red-700">{{ t.error }}</div>
                              {% endif %}
                            </div>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                  {% empty %}
                    <div class="text-sm text-slate-600">Aucune notification prête pour cette assignation.</div>
                  {% endfor %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-sm text-slate-600">Aucune notification enregistrée pour cette couverture.</div>
        {% endif %}
      </div>

      <div class="mt-6">
        <div class="text-xl font-semibold mb-4">Ajouter des membres</div>
        {% if coverage.status == 'review' or coverage.status == 'scheduled' %}
          <form method="post" action="{% url 'editorial_assign_coverage' coverage.id %}" class="space-y-4">
            {% csrf_token %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="border rounded-xl p-4">
                <div class="flex items-center justify-between gap-3 mb-3">
                  <div>
                    <div class="font-semibold">Journalistes</div>
                    <div class="text-xs text-slate-500">Sélection par clic (multi-choix)</div>
                  </div>
                  <div class="text-xs text-slate-500">{{ all_journalists|length }} au total</div>
                </div>
                <div class="border rounded-lg overflow-hidden">
                  <div class="max-h-80 overflow-y-auto divide-y">
                    {% for j in all_journalists %}
                      <label class="flex items-start gap-3 px-3 py-2 hover:bg-slate-50 cursor-pointer">
                        <input type="checkbox" name="journalist_ids" value="{{ j.id }}" class="mt-1" />
                        <div class="text-sm">
                          <div class="font-medium">{{ j.name }}</div>
                          {% if j.specialties %}
                            <div class="text-xs text-slate-500">{{ j.specialties }}</div>
                          {% endif %}
                        </div>
                      </label>
                    {% endfor %}
                  </div>
                </div>
              </div>

              <div class="border rounded-xl p-4">
                <div class="flex items-center justify-between gap-3 mb-3">
                  <div>
                    <div class="font-semibold">Chauffeurs</div>
                    <div class="text-xs text-slate-500">Sélection par clic (multi-choix)</div>
                  </div>
                  <div class="text-xs text-slate-500">{{ all_drivers|length }} au total</div>
                </div>
                <div class="border rounded-lg overflow-hidden">
                  <div class="max-h-80 overflow-y-auto divide-y">
                    {% for d in all_drivers %}
                      <label class="flex items-start gap-3 px-3 py-2 hover:bg-slate-50 cursor-pointer">
                        <input type="checkbox" name="driver_ids" value="{{ d.id }}" class="mt-1" />
                        <div class="text-sm">
                          <div class="font-medium">{{ d.name }}</div>
                          {% if d.phone %}
                            <div class="text-xs text-slate-500">{{ d.phone }}</div>
                          {% endif %}
                        </div>
                      </label>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>

            <div class="flex items-center justify-end">
              <button class="btn btn--primary">Valider l’assignation</button>
            </div>
          </form>
        {% else %}
          <div class="text-sm text-slate-600">Couverture non validée par l’administration.</div>
        {% endif %}
      </div>
    </section>

    
  </div>
</div>
{% endblock %}

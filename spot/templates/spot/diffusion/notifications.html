{% extends 'spot/diffusion/base_diffusion.html' %}
{% block title %}Notifications diffuseur{% endblock %}
{% block content %}
<h1 class="heading text-3xl font-semibold text-gray-800 mb-6 flex items-center"><i class="fa-solid fa-bell mr-2 text-red-600"></i> Notifications</h1>

<div class="bg-white shadow rounded-lg p-6">
  <form id="csrf-token-form" style="display:none">{% csrf_token %}</form>
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-3">
      <span class="text-sm text-gray-600">{{ notifications.paginator.count }} notification{{ notifications.paginator.count|pluralize }}</span>
      {% if unread_count %}
      <span class="badge badge-red" id="notif-badge-count">{{ unread_count }}</span>
      {% endif %}
    </div>
    <div class="flex items-center gap-3">
      {% if unread_count %}
      <button onclick="markAllAsRead()" class="btn btn--outline"><i class="fa-solid fa-check-double mr-2"></i>Tout marquer comme lu</button>
      {% endif %}
      <a href="/diffusion/" class="btn btn--ghost"><i class="fa-solid fa-arrow-left mr-2"></i>Retour</a>
    </div>
  </div>

  <div id="notificationsList">
    {% include 'spot/includes/notifications_list.html' %}
  </div>

  {% if notifications.has_other_pages %}
  <div class="mt-6 flex items-center justify-between">
    <div class="text-sm text-gray-600">Affichage de {{ notifications.start_index }} à {{ notifications.end_index }} sur {{ notifications.paginator.count }}</div>
    <div class="flex gap-2">
      {% if notifications.has_previous %}
      <a href="?page={{ notifications.previous_page_number }}" class="px-3 py-2 border rounded text-sm">Précédent</a>
      {% endif %}
      {% for num in notifications.paginator.page_range %}
        {% if notifications.number == num %}
          <span class="px-3 py-2 bg-red-600 text-white rounded text-sm">{{ num }}</span>
        {% elif num > notifications.number|add:'-3' and num < notifications.number|add:'3' %}
          <a href="?page={{ num }}" class="px-3 py-2 border rounded text-sm">{{ num }}</a>
        {% endif %}
      {% endfor %}
      {% if notifications.has_next %}
      <a href="?page={{ notifications.next_page_number }}" class="px-3 py-2 border rounded text-sm">Suivant</a>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>

<script>
function getCookie(name){
  var cookieValue = null;
  if(document.cookie && document.cookie !== ''){
    var cookies = document.cookie.split(';');
    for(var i = 0; i < cookies.length; i++){
      var cookie = cookies[i].trim();
      if(cookie.substring(0, name.length + 1) === (name + '=')){
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function getCsrfToken(){
  var form = document.getElementById('csrf-token-form');
  if(form){
    var input = form.querySelector('input[name="csrfmiddlewaretoken"]');
    if(input && input.value) return input.value;
  }
  return getCookie('csrftoken') || '';
}

function updateNotifBadge(count){
  var b = document.getElementById('notif-badge-count');
  if(!b) return;
  if(count && count > 0){
    b.textContent = count;
    b.classList.remove('hidden');
  } else {
    b.textContent = '';
    b.classList.add('hidden');
  }
}

function requestJson(method, url, onOk, onErr){
  var xhr = new XMLHttpRequest();
  xhr.open(method, url, true);
  xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
  if(method === 'POST'){
    xhr.setRequestHeader('X-CSRFToken', getCsrfToken());
  }
  xhr.onreadystatechange = function(){
    if(xhr.readyState !== 4) return;
    if(xhr.status >= 200 && xhr.status < 300){
      var data = null;
      try{
        data = JSON.parse(xhr.responseText || '{}');
      }catch(e){
        if(onErr) onErr(e);
        return;
      }
      if(onOk) onOk(data);
      return;
    }
    if(onErr) onErr(new Error('HTTP ' + xhr.status));
  };
  xhr.send(null);
}

function reloadNotifications(){
  requestJson('GET', '{% url "diffusion_notifications_list_partial" %}', function(data){
    if(data.status === 'success'){
      var el = document.getElementById('notificationsList');
      if(el) el.innerHTML = data.html;
      updateNotifBadge(data.unread_count);
    }
  }, function(){});
}

function markAsRead(notificationId, cb){
  var urlTpl = '{% url "diffusion_notifications_mark_read" id=0 %}';
  var url = urlTpl.replace('0', String(notificationId));
  requestJson('POST', url, function(data){
    if(data.status === 'success'){
      updateNotifBadge(data.unread_count);
      if(cb) cb(true);
      return;
    }
    if(cb) cb(false);
  }, function(){
    if(cb) cb(false);
  });
}

function markAllAsRead(){
  if(!confirm('Marquer toutes les notifications comme lues ?')) return;
  requestJson('POST', '{% url "diffusion_notifications_mark_all_read" %}', function(data){
    if(data.status === 'success'){
      updateNotifBadge(data.unread_count);
      reloadNotifications();
    }
  }, function(){});
}

function deleteNotification(notificationId){
  if(!confirm('Supprimer cette notification ?')) return;
  var urlTpl = '{% url "diffusion_notifications_delete" id=0 %}';
  var url = urlTpl.replace('0', String(notificationId));
  requestJson('POST', url, function(data){
    if(data.status === 'success'){
      updateNotifBadge(data.unread_count);
      reloadNotifications();
    }
  }, function(){
    alert('Erreur lors de la suppression.');
  });
}

(function(){
  var list = document.getElementById('notificationsList');
  if(!list) return;
  var proto = window.Element && Element.prototype;
  var _matches = proto && (proto.matches || proto.msMatchesSelector || proto.webkitMatchesSelector);
  function matches(el, selector){
    if(!el || el.nodeType !== 1 || !_matches) return false;
    return _matches.call(el, selector);
  }
  function closest(el, selector){
    var cur = el;
    while(cur && cur.nodeType === 1){
      if(matches(cur, selector)) return cur;
      cur = cur.parentElement;
    }
    return null;
  }

  list.addEventListener('click', function(e){
    var li = closest(e.target, '.js-notif-item');
    if(!li || !list.contains(li)) return;
    if(closest(e.target, '.js-notif-delete')) return;
    if(li.getAttribute('data-notif-is-read') === '1') return;

    var link = closest(e.target, 'a[href]');
    var notifId = li.getAttribute('data-notif-id');
    if(link){
      e.preventDefault();
      markAsRead(notifId, function(){
        var href = link.getAttribute('href');
        if(href) window.location.href = href;
      });
      return;
    }
    markAsRead(notifId, function(ok){
      if(ok) reloadNotifications();
    });
  });
})();
</script>
{% endblock %}

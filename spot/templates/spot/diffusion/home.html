{% extends 'spot/diffusion/base_diffusion.html' %}
{% load static %}
{% block title %}Accueil – Diffusion{% endblock %}

{% block content %}
<!-- Hero premium -->
<section class="relative rounded-xl overflow-hidden mb-8 fade-in" aria-label="Présentation">
  <img src="{% static 'bf1_spots.jpg' %}" alt="Présentation BF1 spots" class="w-full h-56 md:h-72 object-cover" loading="eager">
  <div class="absolute inset-0 premium-gradient opacity-90"></div>
  <div class="absolute inset-0 flex items-center">
    <div class="px-6 md:px-10">
      <h1 class="heading text-white text-4xl md:text-5xl font-semibold leading-tight">BF1 Diffusion – La maîtrise de vos campagnes</h1>
      <p class="text-red-100 mt-3 max-w-2xl">Planifiez, gérez et pilotez vos spots avec fluidité. Une interface premium conçue pour aller vite et voir clair.</p>
      <div class="mt-5 flex flex-wrap gap-3">
        <a href="/diffusion/spots/" class="px-5 py-3 bg-white text-red-700 rounded-lg shadow hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-white" aria-label="Voir les spots">
          <i class="fa-solid fa-video mr-2"></i> Voir les spots
        </a>
        <a href="/diffusion/planning/" class="px-5 py-3 bg-red-700 text-white rounded-lg shadow hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-white" aria-label="Voir le planning">
          <i class="fa-solid fa-calendar-days mr-2"></i> Voir le planning
        </a>
      </div>
    </div>
  </div>
  <div class="sr-only">Image décorative du bandeau d’accueil.</div>
  </section>

<!-- KPI Cards -->
<section class="grid grid-cols-1 md:grid-cols-3 gap-6" aria-label="Indicateurs clés">
  <div class="glass rounded-xl p-6 hover-raise" role="article">
    <p class="text-gray-500">Spots à diffuser aujourd'hui</p>
    <p id="kpi-spots-today" class="text-3xl font-bold text-red-600" aria-live="polite">{{ kpi_spots_today }}</p>
  </div>
  <div class="glass rounded-xl p-6 hover-raise" role="article">
    <p class="text-gray-500">Spots en retard</p>
    <p id="kpi-late-spots" class="text-3xl font-bold text-red-600" aria-live="polite">{{ kpi_late_spots }}</p>
    {% if kpi_late_spots %}
    <div class="mt-3 text-sm text-red-700">Alertes actives: consultez la liste ci-dessous.</div>
    {% endif %}
  </div>
  <div class="glass rounded-xl p-6 hover-raise" role="article">
    <p class="text-gray-500">Programmés cette semaine</p>
    <div id="kpi-week" class="mt-2 space-y-1" aria-live="polite">
      {% for day, count in kpi_week_counts.items %}
      <div class="flex justify-between text-sm"><span>{{ day }}</span><span class="font-semibold">{{ count }}</span></div>
      {% endfor %}
    </div>
  </div>
</section>

<!-- Synthèse du jour & alertes -->
<section class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8" aria-label="Synthèse du jour">
  <div class="card p-6">
    <h2 class="text-lg font-semibold text-gray-800">À diffuser aujourd'hui</h2>
    <ul class="mt-3 divide-y divide-gray-200">
      {% for s in spots_today_list %}
      <li class="py-3 flex items-center justify-between">
        <div>
          <p class="font-medium">{{ s.spot.title }}</p>
          <p class="text-sm text-gray-500">{{ s.broadcast_time }} – {{ s.spot.campaign.client.username }}</p>
        </div>
        <span class="inline-flex items-center px-2 py-1 text-xs bg-gray-100 rounded">Prochaine diffusion</span>
      </li>
      {% empty %}
      <li class="py-3 text-gray-500">Aucun spot prévu aujourd'hui.</li>
      {% endfor %}
    </ul>
  </div>
  <div class="card p-6">
    <h2 class="text-lg font-semibold text-gray-800">En retard</h2>
    <ul class="mt-3 divide-y divide-gray-200">
      {% for s in late_spots_list %}
      <li class="py-3 flex items-center justify-between">
        <div>
          <p class="font-medium">{{ s.spot.title }}</p>
          <p class="text-sm text-gray-500">Prévu {{ s.broadcast_date }} {{ s.broadcast_time }} – {{ s.spot.campaign.client.username }}</p>
        </div>
        <span class="inline-flex items-center px-2 py-1 text-xs bg-red-100 text-red-700 rounded">En retard</span>
      </li>
      {% empty %}
      <li class="py-3 text-gray-500">Aucun spot en retard.</li>
      {% endfor %}
    </ul>
  </div>
</section>

<!-- Section modules & CTA secondaires -->
<section class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8" aria-label="Actions rapides">
  
  
</section>

<!-- Problèmes signalés (placeholder) -->
<section class="card p-6 mt-8" aria-label="Problèmes récemment signalés">
  <h2 class="text-lg font-semibold text-gray-800">Problèmes récemment signalés</h2>
  <p class="mt-2 text-sm text-gray-500">Module de suivi des incidents en cours d’intégration.</p>
</section>

<!-- Accessibilité & performance -->
<script>
// Polling léger pour KPI (respecte reduced-motion)
const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
async function refreshKPI(){
  try{
    const r = await fetch('/diffusion/api/kpi/');
    if(!r.ok) return;
    const d = await r.json();
    const s = document.getElementById('kpi-spots-today');
    const l = document.getElementById('kpi-late-spots');
    const w = document.getElementById('kpi-week');
    if(s) s.textContent = d.spots_today;
    if(l) l.textContent = d.late_spots;
    if(w){
      w.innerHTML = '';
      Object.keys(d.week).forEach(k=>{
        const row = document.createElement('div');
        row.className = 'flex justify-between text-sm';
        row.innerHTML = `<span>${k}</span><span class="font-semibold">${d.week[k]}</span>`;
        w.appendChild(row);
      });
    }
  }catch(e){/* silencieux */}
}
if(!prefersReduced){ setInterval(refreshKPI, 15000); }
</script>
{% endblock %}
{% extends 'spot/base.html' %}

{% block title %}Mon Profil - BF1{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-6">
  <section class="bg-white rounded-2xl bf1-shadow p-6 sm:p-8">
    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-6">
      <div class="flex items-center gap-4 min-w-0">
        <form method="post" action="{% url 'profile' %}" enctype="multipart/form-data" class="flex-none">
          {% csrf_token %}
          <input type="hidden" name="profile_action" value="photo">
          <input id="profile-photo-input" type="file" name="photo" accept="image/*" class="hidden">
          <div class="relative">
            <button type="button" id="profile-photo-view-trigger"
                    class="block rounded-full focus:outline-none focus:ring-2 focus:ring-bf1-red"
                    aria-label="Voir la photo de profil">
              {% if user.photo %}
              <img src="{{ user.photo.url }}"
                   alt="Avatar de {{ user.username }}"
                   class="w-16 h-16 rounded-full ring-2 ring-bf1-red-light object-cover" loading="lazy">
              {% else %}
              <img src="https://ui-avatars.com/api/?name={{ user.username }}&background=E63946&color=fff&size=256"
                   alt="Avatar de {{ user.username }}"
                   class="w-16 h-16 rounded-full ring-2 ring-bf1-red-light" loading="lazy">
              {% endif %}
            </button>
            <button type="button" id="profile-photo-trigger-badge"
                    class="absolute -bottom-1 -right-1 w-8 h-8 rounded-full bg-gray-900 text-white flex items-center justify-center shadow-md hover:bg-black focus:outline-none focus:ring-2 focus:ring-bf1-red"
                    aria-label="Ajouter ou modifier la photo de profil">
              <i class="fas fa-camera text-xs"></i>
            </button>
          </div>
        </form>
        <div class="min-w-0">
          <div class="flex flex-wrap items-center gap-2">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 u-clamp-2">{{ user.first_name }} {{ user.last_name }}</h1>
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold {% if user.is_admin %}bg-purple-100 text-purple-800{% else %}bg-blue-100 text-blue-800{% endif %}">
              {{ user.get_role_display }}
            </span>
          </div>
          <p class="mt-1 text-gray-600 text-sm sm:text-base u-clamp-2">
            {{ user.email }}{% if user.phone %} · {{ user.phone }}{% endif %}{% if user.company %} · {{ user.company }}{% endif %}
          </p>
          <p class="mt-1 text-xs text-gray-500 u-clamp-2">
            Membre depuis {{ user.date_joined|date:"d/m/Y" }}{% if user.last_login %} · Dernière connexion {{ user.last_login|date:"d/m/Y H:i" }}{% endif %}
          </p>
        </div>
      </div>
    </div>
  </section>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2 space-y-6">
      <section class="bg-white rounded-2xl bf1-shadow p-6">
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
          <div class="min-w-0">
            <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
              <i class="fas fa-user text-bf1-red"></i>
              <span>Informations personnelles</span>
            </h2>
            <p class="mt-1 text-sm text-gray-600 u-clamp-2">Vérifiez et mettez à jour vos coordonnées.</p>
          </div>
          <button id="toggle-personal-form" type="button" class="px-4 py-2 rounded-lg bg-gray-900 text-white hover:bg-black text-sm"
                  aria-controls="personal-form-container" aria-expanded="{% if open_profile_form %}true{% else %}false{% endif %}">
            <i class="fas fa-pen mr-2"></i>Modifier
          </button>
        </div>

        <div class="mt-5 bg-gray-50 rounded-xl p-4">
          <dl class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
            <div class="min-w-0">
              <dt class="text-gray-600">Email</dt>
              <dd class="font-medium text-gray-900 u-ellipsis">{{ user.email }}</dd>
            </div>
            <div class="min-w-0">
              <dt class="text-gray-600">Téléphone</dt>
              <dd class="font-medium text-gray-900 u-ellipsis">{{ user.phone|default:"—" }}</dd>
            </div>
            <div class="min-w-0">
              <dt class="text-gray-600">Entreprise</dt>
              <dd class="font-medium text-gray-900 u-ellipsis">{{ user.company|default:"—" }}</dd>
            </div>
            <div class="sm:col-span-2 min-w-0">
              <dt class="text-gray-600">Adresse</dt>
              <dd class="font-medium text-gray-900 u-clamp-2">{{ user.address|default:"—" }}</dd>
            </div>
            <div class="min-w-0">
              <dt class="text-gray-600">Rôle</dt>
              <dd class="font-medium text-gray-900 u-ellipsis">{{ user.get_role_display }}</dd>
            </div>
            <div class="min-w-0">
              <dt class="text-gray-600">Membre depuis</dt>
              <dd class="font-medium text-gray-900 u-ellipsis">{{ user.date_joined|date:"d/m/Y" }}</dd>
            </div>
            <div class="sm:col-span-2 min-w-0">
              <dt class="text-gray-600">Dernière connexion</dt>
              <dd class="font-medium text-gray-900 u-ellipsis">{% if user.last_login %}{{ user.last_login|date:"d/m/Y H:i" }}{% else %}—{% endif %}</dd>
            </div>
          </dl>
        </div>

        <div id="personal-form-container" class="mt-6 {% if not open_profile_form %}hidden{% endif %}">
          <form method="post" action="{% url 'profile' %}" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}
            <div>
              <h3 class="text-lg font-medium text-gray-900 mb-4">Identité</h3>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="min-w-0">
                  <label for="first_name" class="block text-sm font-medium text-gray-700 mb-1">Prénom</label>
                  <input type="text" id="first_name" name="first_name" value="{{ user.first_name }}"
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-bf1-red focus:border-bf1-red">
                </div>
                <div class="min-w-0">
                  <label for="last_name" class="block text-sm font-medium text-gray-700 mb-1">Nom</label>
                  <input type="text" id="last_name" name="last_name" value="{{ user.last_name }}"
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-bf1-red focus:border-bf1-red">
                </div>
                <div class="min-w-0">
                  <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Nom d'utilisateur</label>
                  <input type="text" id="username" value="{{ user.username }}" disabled
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500">
                </div>
                <div class="min-w-0">
                  <label for="company" class="block text-sm font-medium text-gray-700 mb-1">Entreprise</label>
                  <input type="text" id="company" name="company" value="{{ user.company }}"
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-bf1-red focus:border-bf1-red">
                </div>
              </div>
            </div>

            <div>
              <h3 class="text-lg font-medium text-gray-900 mb-4">Contact</h3>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="min-w-0">
                  <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                  <input type="email" id="email" name="email" value="{{ user.email }}"
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-bf1-red focus:border-bf1-red">
                </div>
                <div class="min-w-0">
                  <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Téléphone</label>
                  <input type="tel" id="phone" name="phone" value="{{ user.phone }}"
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-bf1-red focus:border-bf1-red">
                </div>
              </div>
            </div>

            <div>
              <h3 class="text-lg font-medium text-gray-900 mb-4">Adresse</h3>
              <textarea id="address" name="address" rows="3"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-bf1-red focus:border-bf1-red">{{ user.address }}</textarea>
            </div>

            <div class="bg-gray-50 rounded-xl p-4">
              <div class="flex items-center justify-between gap-4">
                <div class="min-w-0">
                  <div class="text-sm font-medium text-gray-900">Mot de passe</div>
                  <div class="text-xs text-gray-600 u-clamp-2">Laissez masqué si vous ne souhaitez pas le changer.</div>
                </div>
                <button id="toggle-password-fields" type="button" class="px-3 py-2 rounded-lg bg-white text-gray-900 hover:bg-gray-100 text-sm border border-gray-200"
                        aria-controls="password-fields" aria-expanded="{% if open_password_section %}true{% else %}false{% endif %}">
                  Changer
                </button>
              </div>
              <div id="password-fields" class="mt-4 {% if not open_password_section %}hidden{% endif %}">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div class="min-w-0">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Nouveau mot de passe</label>
                    <input type="password" id="password" name="password" autocomplete="new-password"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-bf1-red focus:border-bf1-red">
                    <p class="text-xs text-gray-500 mt-1">Minimum 8 caractères.</p>
                  </div>
                  <div class="min-w-0">
                    <label for="password_confirm" class="block text-sm font-medium text-gray-700 mb-1">Confirmer</label>
                    <input type="password" id="password_confirm" name="password_confirm" autocomplete="new-password"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-bf1-red focus:border-bf1-red">
                  </div>
                </div>
              </div>
            </div>

            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-end gap-3">
              <button type="submit" class="bg-bf1-red text-white py-2 px-6 rounded-lg hover:bg-bf1-red-dark focus:outline-none focus:ring-2 focus:ring-bf1-red transition-colors">
                <i class="fas fa-save mr-2"></i>Enregistrer
              </button>
            </div>
          </form>
        </div>
      </section>
    </div>

    <aside class="space-y-6">
      {% if user.is_client %}
      <section class="bg-white rounded-2xl bf1-shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
          <i class="fas fa-chart-pie text-bf1-red"></i>
          <span>Statistiques</span>
        </h3>
        <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div class="bg-gray-50 rounded-xl p-4">
            <div class="text-xs text-gray-600">Campagnes</div>
            <div class="mt-1 text-2xl font-bold text-bf1-red">{{ stats.total_campaigns|default:"0" }}</div>
          </div>
          <div class="bg-gray-50 rounded-xl p-4">
            <div class="text-xs text-gray-600">Actives</div>
            <div class="mt-1 text-2xl font-bold text-green-600">{{ stats.active_campaigns|default:"0" }}</div>
          </div>
          <div class="bg-gray-50 rounded-xl p-4">
            <div class="text-xs text-gray-600">Spots</div>
            <div class="mt-1 text-2xl font-bold text-bf1-red">{{ stats.total_spots|default:"0" }}</div>
          </div>
          <div class="bg-gray-50 rounded-xl p-4">
            <div class="text-xs text-gray-600">En attente</div>
            <div class="mt-1 text-2xl font-bold text-yellow-600">{{ stats.pending_spots|default:"0" }}</div>
          </div>
        </div>
      </section>
      {% endif %}
    </aside>
  </div>
</div>

<div id="profile-photo-modal" class="hidden fixed inset-0 z-50">
  <div id="profile-photo-modal-backdrop" class="absolute inset-0 bg-black/70"></div>
  <div class="relative w-full h-full flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl overflow-hidden shadow-xl w-full max-w-2xl" role="dialog" aria-modal="true" aria-label="Photo de profil">
      <div class="p-4 border-b flex items-center justify-between">
        <div class="font-semibold text-gray-900">Photo de profil</div>
        <button type="button" id="profile-photo-modal-close" class="text-gray-600 hover:text-gray-900" aria-label="Fermer">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-4 bg-gray-50">
        <img id="profile-photo-modal-image" alt="Photo de profil" class="w-full h-auto max-h-[70vh] object-contain rounded-xl bg-white">
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    const btn = document.getElementById('toggle-personal-form');
    const panel = document.getElementById('personal-form-container');
    if (!btn || !panel) return;
    btn.addEventListener('click', function() {
      const isOpen = !panel.classList.contains('hidden');
      panel.classList.toggle('hidden', isOpen);
      btn.setAttribute('aria-expanded', (!isOpen).toString());
    });
  })();

  (function() {
    const input = document.getElementById('profile-photo-input');
    const triggerBadge = document.getElementById('profile-photo-trigger-badge');
    if (!input) return;
    const openPicker = function() {
      input.click();
    };
    if (triggerBadge) triggerBadge.addEventListener('click', openPicker);
    input.addEventListener('change', function() {
      if (!input.files || !input.files.length) return;
      const form = input.closest('form');
      if (form) form.submit();
    });
  })();

  (function() {
    const trigger = document.getElementById('profile-photo-view-trigger');
    const modal = document.getElementById('profile-photo-modal');
    const backdrop = document.getElementById('profile-photo-modal-backdrop');
    const closeBtn = document.getElementById('profile-photo-modal-close');
    const img = document.getElementById('profile-photo-modal-image');
    if (!trigger || !modal || !img) return;
    const avatarImg = trigger.querySelector('img');
    if (!avatarImg) return;
    const open = function() {
      img.src = avatarImg.currentSrc || avatarImg.src || '';
      modal.classList.remove('hidden');
    };
    const close = function() {
      modal.classList.add('hidden');
      img.removeAttribute('src');
    };
    trigger.addEventListener('click', open);
    if (closeBtn) closeBtn.addEventListener('click', close);
    if (backdrop) backdrop.addEventListener('click', close);
    document.addEventListener('keydown', function(e) {
      if (e.key !== 'Escape') return;
      if (!modal.classList.contains('hidden')) close();
    });
  })();

  (function() {
    const toggle = document.getElementById('toggle-password-fields');
    const panel = document.getElementById('password-fields');
    if (!toggle || !panel) return;
    toggle.addEventListener('click', function() {
      const isOpen = !panel.classList.contains('hidden');
      panel.classList.toggle('hidden', isOpen);
      toggle.setAttribute('aria-expanded', (!isOpen).toString());
    });
  })();

  (function() {
    const container = document.getElementById('personal-form-container');
    if (!container) return;
    const form = container.querySelector('form');
    if (!form) return;
    const pwd = document.getElementById('password');
    const confirm = document.getElementById('password_confirm');
    form.addEventListener('submit', function(e) {
      if (pwd && confirm && pwd.value && pwd.value !== confirm.value) {
        e.preventDefault();
        alert('Les mots de passe ne correspondent pas.');
      }
    });
  })();
</script>
{% endblock %}

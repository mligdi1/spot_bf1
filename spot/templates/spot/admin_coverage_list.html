{% extends 'spot/admin_base.html' %}
{% block admin_header %}Couvertures{% endblock %}
{% block admin_content %}
<div class="space-y-6">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <h1 class="text-2xl font-bold">Demandes de couverture</h1>
    <a href="{% url 'admin_dashboard' %}" class="text-bf1-red hover:text-bf1-red-dark">Retour dashboard</a>
  </div>

  <form method="get" class="bg-white p-4 rounded-xl shadow-sm grid grid-cols-12 gap-3">
    <input type="text" name="q" value="{{ q }}" placeholder="Rechercher..."
           class="col-span-12 md:col-span-6 w-full border-gray-300 rounded-md shadow-sm focus:ring-bf1-red focus:border-bf1-red"/>
    <select name="status" class="col-span-12 md:col-span-3 w-full border-gray-300 rounded-md shadow-sm focus:ring-bf1-red focus:border-bf1-red">
      <option value="">Tous statuts</option>
      <option value="new" {% if status == 'new' %}selected{% endif %}>Nouveau</option>
      <option value="review" {% if status == 'review' %}selected{% endif %}>En révision</option>
      <option value="scheduled" {% if status == 'scheduled' %}selected{% endif %}>Planifiée</option>
      <option value="closed" {% if status == 'closed' %}selected{% endif %}>Clôturée</option>
    </select>
    <button class="col-span-12 md:col-span-3 bg-bf1-red text-white px-4 py-2 rounded-lg">Filtrer</button>
  </form>

  <div class="bg-white rounded-xl shadow-sm p-6 space-y-4">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div class="flex flex-wrap items-center gap-2">
        <span class="px-3 py-1 rounded-full bg-bf1-red/10 text-bf1-red text-xs">Nouvelles: {{ status_counts.new|default:0 }}</span>
        <span class="px-3 py-1 rounded-full bg-bf1-red/10 text-bf1-red text-xs">En révision: {{ status_counts.review|default:0 }}</span>
        <span class="px-3 py-1 rounded-full bg-bf1-red/10 text-bf1-red text-xs">Planifiées: {{ status_counts.scheduled|default:0 }}</span>
        <span class="px-3 py-1 rounded-full bg-bf1-red/10 text-bf1-red text-xs">Clôturées: {{ status_counts.closed|default:0 }}</span>
      </div>
      <div class="flex flex-wrap items-center gap-2 justify-end">
        <button id="sort-title" class="px-3 py-1 rounded border text-sm">Trier par titre</button>
        <button id="sort-date" class="px-3 py-1 rounded border text-sm">Trier par date</button>
      </div>
    </div>

    {% if page_obj.object_list %}
    <div id="coverage-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      {% for cv in page_obj.object_list %}
      <a href="{% url 'admin_coverage_detail' cv.id %}" class="block border rounded-xl p-4 hover:border-bf1-red" data-title="{{ cv.event_title|lower }}" data-date="{{ cv.event_date|date:'Ymd' }}">
        <div class="flex items-start justify-between">
          <div>
            <div class="font-semibold">{{ cv.event_title }}</div>
            <div class="text-sm text-gray-600">{{ cv.address }}{% if cv.event_date %} • {{ cv.event_date|date:'d/m/Y' }}{% endif %}</div>
            <div class="text-xs text-gray-500 mt-1">{{ cv.get_coverage_type_display }} • {{ cv.get_urgency_level_display }}</div>
          </div>
          <span class="px-2 py-1 rounded-full text-xs
            {% if cv.status == 'new' %}bg-yellow-100 text-yellow-800{% endif %}
            {% if cv.status == 'review' %}bg-blue-100 text-blue-800{% endif %}
            {% if cv.status == 'scheduled' %}bg-green-100 text-green-800{% endif %}
            {% if cv.status == 'closed' %}bg-gray-100 text-gray-800{% endif %}">{{ cv.get_status_display }}</span>
        </div>
        <div class="mt-3 text-sm">Client: {% if cv.user %}{{ cv.user.username }}{% else %}-{% endif %}</div>
      </a>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center text-gray-500 py-6">Aucune demande trouvée</div>
    {% endif %}

    <div class="mt-2 flex items-center justify-between text-sm text-gray-600">
      <div>Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</div>
      <div class="space-x-2">
        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}&status={{ status }}&q={{ q }}" class="px-3 py-1 rounded border">Précédent</a>
        {% endif %}
        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}&status={{ status }}&q={{ q }}" class="px-3 py-1 rounded border">Suivant</a>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    (function(){
      const grid = document.getElementById('coverage-grid');
      if(!grid) return;
      const items = Array.from(grid.children);
      const byTitle = () => items.sort((a,b)=>a.dataset.title.localeCompare(b.dataset.title));
      const byDate = () => items.sort((a,b)=>a.dataset.date.localeCompare(b.dataset.date));
      const render = sorted => { sorted.forEach(el=>grid.appendChild(el)); };
      const st = document.getElementById('sort-title');
      const sd = document.getElementById('sort-date');
      if(st) st.addEventListener('click',()=>render(byTitle()));
      if(sd) sd.addEventListener('click',()=>render(byDate()));
    })();
  </script>
</div>
{% endblock %}

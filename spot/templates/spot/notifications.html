{% extends 'spot/base.html' %}

{% block title %}Notifications - BF1{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- En-tête -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2 flex items-center gap-3">
            <i class="fas fa-bell text-bf1-red mr-2"></i>
            Mes notifications
            {% if unread_count %}
              <span class="px-2 py-0.5 rounded-full text-sm border bg-bf1-red-light text-bf1-red border-bf1-red-light">
                {{ unread_count }} non lus
              </span>
            {% endif %}
        </h1>
        <p class="text-gray-600">
            Restez informé de toutes les activités liées à vos campagnes
        </p>
    </div>

    <!-- Actions rapides -->
    <div class="bg-white p-4 rounded-lg bf1-shadow mb-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-600">
                    {{ notifications.paginator.count }} notification{{ notifications.paginator.count|pluralize }}
                </span>
                {% if unread_count %}
                    <button onclick="markAllAsRead()" class="text-bf1-red hover:text-bf1-red-dark text-sm font-medium">
                        <i class="fas fa-check-double mr-1"></i>
                        Tout marquer comme lu
                    </button>
                {% endif %}
            </div>
            <div class="mt-2 sm:mt-0">
                <a href="{% url 'home' %}" class="text-bf1-red hover:text-bf1-red-dark font-medium">
                    <i class="fas fa-arrow-left mr-1"></i>
                    Retour à l'accueil
                </a>
            </div>
        </div>
    </div>

    <!-- Liste des notifications -->
    <div id="notificationsList">
      {% include 'spot/includes/notifications_list.html' %}
    </div>
    
    <!-- Pagination -->
        {% if notifications.has_other_pages %}
        <div class="mt-8 flex items-center justify-between">
            <div class="text-sm text-gray-700">
                Affichage de {{ notifications.start_index }} à {{ notifications.end_index }} 
                sur {{ notifications.paginator.count }} notifications
            </div>
            
            <div class="flex space-x-2">
                {% if notifications.has_previous %}
                    <a href="?page={{ notifications.previous_page_number }}" 
                       class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Précédent
                    </a>
                {% endif %}
                
                {% for num in notifications.paginator.page_range %}
                    {% if notifications.number == num %}
                        <span class="px-3 py-2 bg-bf1-red text-white rounded-md text-sm font-medium">
                            {{ num }}
                        </span>
                    {% elif num > notifications.number|add:'-3' and num < notifications.number|add:'3' %}
                        <a href="?page={{ num }}" 
                           class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                            {{ num }}
                        </a>
                    {% endif %}
                {% endfor %}
                
                {% if notifications.has_next %}
                    <a href="?page={{ notifications.next_page_number }}" 
                       class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Suivant
                    </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
</div>

<script>
function getCookie(name){
  var cookieValue = null;
  if(document.cookie && document.cookie !== ''){
    var cookies = document.cookie.split(';');
    for(var i = 0; i < cookies.length; i++){
      var cookie = cookies[i].trim();
      if(cookie.substring(0, name.length + 1) === (name + '=')){
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function updateNotifBadge(count){
  var badge = document.getElementById('notif-badge-count');
  if(!badge) return;
  if(count && count > 0){
    badge.textContent = count;
    badge.classList.remove('hidden');
  }else{
    badge.textContent = '';
    badge.classList.add('hidden');
  }
}

function requestJson(method, url, onOk, onErr){
  var xhr = new XMLHttpRequest();
  xhr.open(method, url, true);
  xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
  if(method === 'POST'){
    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken') || '');
  }
  xhr.onreadystatechange = function(){
    if(xhr.readyState !== 4) return;
    if(xhr.status >= 200 && xhr.status < 300){
      var data = null;
      try{ data = JSON.parse(xhr.responseText || '{}'); }catch(e){ if(onErr) onErr(e); return; }
      if(onOk) onOk(data);
      return;
    }
    if(onErr) onErr(new Error('HTTP ' + xhr.status));
  };
  xhr.send(null);
}

function reloadNotifications(){
  requestJson('GET', '{% url "notifications_list_partial" %}', function(data){
    if(data.status === 'success'){
      var el = document.getElementById('notificationsList');
      if(el) el.innerHTML = data.html;
      updateNotifBadge(data.unread_count);
    }
  }, function(){});
}

function markAsRead(notificationId, cb){
  var urlTpl = '{% url "notifications_mark_read" id=0 %}';
  var url = urlTpl.replace('0', String(notificationId));
  requestJson('POST', url, function(data){
    if(data.status === 'success'){
      updateNotifBadge(data.unread_count);
      if(cb) cb(true);
      return;
    }
    if(cb) cb(false);
  }, function(){
    if(cb) cb(false);
  });
}

function markAllAsRead(){
  if(!confirm('Marquer toutes les notifications comme lues ?')) return;
  requestJson('POST', '{% url "notifications_mark_all_read" %}', function(data){
    if(data.status === 'success'){
      updateNotifBadge(data.unread_count);
      reloadNotifications();
    }
  }, function(){});
}

function deleteNotification(notificationId){
  if(!confirm('Supprimer cette notification ?')) return;
  var urlTpl = '{% url "notifications_delete" id=0 %}';
  var url = urlTpl.replace('0', String(notificationId));
  requestJson('POST', url, function(data){
    if(data.status === 'success'){
      updateNotifBadge(data.unread_count);
      reloadNotifications();
    }
  }, function(){
    alert('Erreur lors de la suppression.');
  });
}

(function(){
  var list = document.getElementById('notificationsList');
  if(!list) return;
  var proto = window.Element && Element.prototype;
  var _matches = proto && (proto.matches || proto.msMatchesSelector || proto.webkitMatchesSelector);
  function matches(el, selector){
    if(!el || el.nodeType !== 1 || !_matches) return false;
    return _matches.call(el, selector);
  }
  function closest(el, selector){
    var cur = el;
    while(cur && cur.nodeType === 1){
      if(matches(cur, selector)) return cur;
      cur = cur.parentElement;
    }
    return null;
  }
  list.addEventListener('click', function(e){
    var li = closest(e.target, '.js-notif-item');
    if(!li || !list.contains(li)) return;
    if(closest(e.target, '.js-notif-delete')) return;
    if(li.getAttribute('data-notif-is-read') === '1') return;

    var link = closest(e.target, 'a[href]');
    var notifId = li.getAttribute('data-notif-id');
    if(link){
      e.preventDefault();
      markAsRead(notifId, function(){
        var href = link.getAttribute('href');
        if(href) window.location.href = href;
      });
      return;
    }
    markAsRead(notifId, function(ok){
      if(ok) reloadNotifications();
    });
  });
})();
</script>
{% endblock %}

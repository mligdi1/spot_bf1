{% extends 'spot/base.html' %}
{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 grid grid-cols-1 lg:grid-cols-12 gap-6">
  <!-- Navigation latérale -->
  <aside class="lg:col-span-3 bg-white rounded p-4 shadow">
    <h2 class="text-lg font-semibold text-gray-900 mb-3">Rapports</h2>
    <nav class="space-y-1">
      <a href="#section-overview" class="block px-3 py-2 rounded text-gray-700 hover:bg-gray-50">Vue d’ensemble</a>
      <a href="#section-activities" class="block px-3 py-2 rounded text-gray-700 hover:bg-gray-50">Activités</a>
      <!-- Section Tendances retirée pour alléger la page et éviter la confusion -->
    </nav>
    
  </aside>

  <!-- Contenu principal -->
  <section class="lg:col-span-9">
    <div id="section-overview" class="bg-white rounded p-5 shadow">
      <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
        <div>
          <h1 class="text-2xl md:text-3xl font-semibold text-gray-900">Rapports</h1>
          <p class="text-gray-600">Filtrez vos campagnes et visualisez les tendances.</p>
          <div class="mt-3 inline-flex rounded-lg border bg-white">
            <button id="tab-campaigns" type="button" class="px-3 py-1.5 text-sm rounded-l-lg bg-bf1-red text-white">Campagnes</button>
            <button id="tab-coverage" type="button" class="px-3 py-1.5 text-sm rounded-r-lg text-gray-700">Demandes de couverture</button>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <label for="export-format" class="text-sm text-gray-600">Format</label>
          <select id="export-format" class="border rounded px-3 py-2 text-sm">
            {% if request.user.role == 'admin' %}
              <option value="excel">Excel (.xlsx)</option>
              <option value="pdf">PDF</option>
            {% else %}
              <option value="pdf">PDF</option>
            {% endif %}
          </select>
          <button id="export-btn" type="button" class="bg-blue-600 text-white px-4 py-2 rounded text-sm">Exporter</button>
        </div>
      </div>

      <!-- Filtres avancés -->
      <form id="report-filter" method="get" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
        <div class="flex items-center gap-2">
          <input type="date" name="start" value="{{ start_date|date:"Y-m-d" }}" class="border rounded px-3 py-2 text-sm w-full" />
          <input type="date" name="end" value="{{ end_date|date:"Y-m-d" }}" class="border rounded px-3 py-2 text-sm w-full" />
        </div>
        <input type="text" name="q" value="{{ request.GET.q }}" placeholder="Rechercher (titre, client)" class="border rounded px-3 py-2 text-sm w-full" />
        <div class="flex items-center gap-2">
          <select name="status" class="border rounded px-3 py-2 text-sm w-full">
            <option value="">Tous statuts</option>
            <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>En attente</option>
            <option value="approved" {% if request.GET.status == 'approved' %}selected{% endif %}>Approuvée</option>
            <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>Active</option>
            <option value="archived" {% if request.GET.status == 'archived' %}selected{% endif %}>Archivée</option>
          </select>
          <select name="channel" class="border rounded px-3 py-2 text-sm w-full">
            <option value="">Tous canaux</option>
            <option value="tv" {% if request.GET.channel == 'tv' %}selected{% endif %}>TV</option>
            <option value="digital" {% if request.GET.channel == 'digital' %}selected{% endif %}>Digital</option>
          </select>
        </div>
        <div class="flex items-center gap-3">
          <button id="filter-btn" class="bg-bf1-red text-white px-4 py-2 rounded text-sm flex items-center gap-2">
            <span>Appliquer</span>
            <span id="filter-spinner" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
          </button>
        </div>
      </form>

      <!-- Indicateurs clés (sans Diffusions/Durée) -->
      <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div class="bg-gray-50 p-4 rounded">
          <div class="text-gray-600">Campagnes</div>
          <div class="text-2xl font-bold">{{ campaigns_count }}</div>
        </div>
        <div class="bg-gray-50 p-4 rounded">
          <div class="text-gray-600">Budget du mois</div>
          <div class="text-2xl font-bold">{{ total_budget_month|default:0 }} FCFA</div>
        </div>
      </div>
    </div>

    <!-- Section Tendances retirée -->

    
    <div id="section-activities" class="mt-6 bg-white rounded p-5 shadow">
      <h2 class="text-xl font-semibold text-gray-900 mb-3">Activités — Campagnes</h2>
      {% if campaigns_month %}
        <div class="overflow-x-auto">
          {% if request.user.role == 'admin' %}
          <!-- Tableau avancé pour administrateurs -->
          <table id="campaign-table" class="min-w-full divide-y divide-gray-200 text-[14px]">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Campagne</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Canal</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Objectif</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Langues</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Durée (jours)</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Budget</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for campaign in campaigns_month %}
                <tr class="hover:bg-gray-50" data-status="{{ campaign.status }}" data-channel="{{ campaign.channel }}" data-title="{{ campaign.title }}" data-client="{% if campaign.client.company %}{{ campaign.client.company }}{% else %}{{ campaign.client.username }}{% endif %}" data-budget="{{ campaign.budget|default:0 }}" data-date="{{ campaign.created_at|date:"Y-m-d" }}">
                  <td class="px-6 py-4 text-xs text-gray-600">{{ campaign.id }}</td>
                  <td class="px-6 py-4"><div class="text-sm font-medium text-gray-900">{{ campaign.title }}</div></td>
                  <td class="px-6 py-4 text-sm text-gray-700">{{ campaign.channel }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{% if campaign.client.company %}{{ campaign.client.company }}{% else %}{{ campaign.client.username }}{% endif %}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="inline-flex items-center px-2 py-1 rounded text-white text-xs" style="background:#4f46e5">{{ campaign.get_status_display }}</span></td>
                  <td class="px-6 py-4 text-sm text-gray-700">{{ campaign.get_objective_display|default:campaign.objective }}</td>
                  <td class="px-6 py-4 text-sm text-gray-700">{{ campaign.languages|default:"—" }}</td>
                  <td class="px-6 py-4 text-sm text-gray-700">{{ campaign.duration_days }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="font-semibold" data-cell="budget">{{ campaign.budget|default:0 }} FCFA</span></td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ campaign.created_at|date:"d/m/Y" }}</td>
                  <td class="px-6 py-4 whitespace-nowrap"><a href="{% url 'campaign_detail' campaign.id %}" class="text-bf1-red hover:text-bf1-red-dark font-medium">Voir</a></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <!-- Tableau simplifié pour utilisateurs -->
          <table id="campaign-table" class="min-w-full divide-y divide-gray-200 text-[14px]">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Campagne</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Canal</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Budget</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for campaign in campaigns_month %}
                <tr class="hover:bg-gray-50" data-status="{{ campaign.status }}" data-channel="{{ campaign.channel }}" data-title="{{ campaign.title }}" data-client="{% if campaign.client.company %}{{ campaign.client.company }}{% else %}{{ campaign.client.username }}{% endif %}" data-budget="{{ campaign.budget|default:0 }}" data-date="{{ campaign.created_at|date:"Y-m-d" }}">
                  <td class="px-6 py-4"><div class="text-sm font-medium text-gray-900">{{ campaign.title }}</div></td>
                  <td class="px-6 py-4 text-sm text-gray-700">{{ campaign.channel }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="inline-flex items-center px-2 py-1 rounded text-white text-xs" style="background:#4f46e5">{{ campaign.get_status_display }}</span></td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="font-semibold" data-cell="budget">{{ campaign.budget|default:0 }} FCFA</span></td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ campaign.created_at|date:"d/m/Y" }}</td>
                  <td class="px-6 py-4 whitespace-nowrap"><a href="{% url 'campaign_detail' campaign.id %}" class="text-bf1-red hover:text-bf1-red-dark font-medium">Voir</a></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          {% endif %}
        </div>
      {% else %}
        <p class="text-gray-600">Aucune activité trouvée pour la période sélectionnée.</p>
      {% endif %}
    </div>

    
    <div id="section-coverage" class="mt-6 bg-white rounded p-5 shadow hidden">
      <h2 class="text-xl font-semibold text-gray-900 mb-3">Activités — Demandes de couverture</h2>
      {% if coverages_month %}
      <div class="overflow-x-auto">
        <table id="coverage-table" class="min-w-full divide-y divide-gray-200 text-[14px]">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Titre</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for cv in coverages_month %}
            <tr class="hover:bg-gray-50" data-title="{{ cv.event_title }}" data-contact="{{ cv.contact_name }}" data-status="{{ cv.status }}" data-date="{{ cv.created_at|date:"Y-m-d" }}">
              <td class="px-6 py-4"><div class="text-sm font-medium text-gray-900">{{ cv.event_title }}</div></td>
              <td class="px-6 py-4 text-sm text-gray-700">{{ cv.contact_name }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="inline-flex items-center px-2 py-1 rounded text-white text-xs" style="background:#4f46e5">{{ cv.get_status_display }}</span></td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ cv.created_at|date:"d/m/Y" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                {% if request.user.role == 'admin' %}
                  <a href="{% url 'admin_coverage_detail' cv.id %}" class="text-bf1-red hover:text-bf1-red-dark font-medium">Voir</a>
                {% else %}
                  <a href="{% url 'coverage_detail' cv.id %}" class="text-bf1-red hover:text-bf1-red-dark font-medium">Voir</a>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p class="text-gray-600">Aucune demande de couverture pour la période sélectionnée.</p>
      {% endif %}
    </div>

    {% if export_history %}
    <div class="mt-6 bg-white rounded p-5 shadow">
      <h3 class="text-lg font-semibold text-gray-900 mb-2">Exports récents</h3>
      <ul class="text-sm text-gray-700 list-disc ml-5">
        {% for h in export_history %}
          <li>
            {{ h.at|date:"d/m/Y H:i" }} — {{ h.format|upper }} ({{ h.start }} → {{ h.end }}) — {{ h.filename }}
          </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </section>
</div>

<!-- Scripts: interactions -->
<script>
  const filterForm = document.getElementById('report-filter');
  const filterBtn = document.getElementById('filter-btn');
  const spinner = document.getElementById('filter-spinner');
  filterForm.addEventListener('submit', function(e) {
    filterBtn.disabled = true;
    spinner.classList.remove('hidden');
  });

  const exportBtn = document.getElementById('export-btn');
  exportBtn.addEventListener('click', function() {
    const params = new URLSearchParams(new FormData(filterForm));
    const fmt = document.getElementById('export-format').value;
    const baseExcel = "{% url 'report_export' %}";
    const basePdf = "{% url 'report_export_pdf' %}";
    const target = fmt === 'pdf' ? basePdf : baseExcel;
    window.location.href = `${target}?${params.toString()}`;
  });

  // Mise en forme conditionnelle budgets
  Array.from(document.querySelectorAll('[data-cell="budget"]')).forEach(el => {
    const v = parseFloat(el.parentElement.parentElement.getAttribute('data-budget')||'0');
    if (v > 500000) el.classList.add('text-green-700');
    else if (v > 100000) el.classList.add('text-green-600');
    else el.classList.add('text-gray-800');
  });

  // Références tableau
  const rows = Array.from(document.querySelectorAll('#campaign-table tbody tr'));

  // Filtre client-side (prévisualisation en temps réel)
  const qInput = filterForm.querySelector('[name="q"]');
  const stSelect = filterForm.querySelector('[name="status"]');
  const chSelect = filterForm.querySelector('[name="channel"]');
  function applyClientFilters(){
    const q = (qInput.value||'').toLowerCase();
    const st = stSelect.value||'';
    const ch = chSelect.value||'';
    rows.forEach(r => {
      const title = (r.getAttribute('data-title')||'').toLowerCase();
      const client = (r.getAttribute('data-client')||'').toLowerCase();
      const okQ = !q || title.includes(q) || client.includes(q);
      const okS = !st || (r.getAttribute('data-status')===st);
      const okC = !ch || (r.getAttribute('data-channel')===ch);
      r.style.display = (okQ && okS && okC) ? '' : 'none';
    });
  }
  [qInput, stSelect, chSelect].forEach(el => el.addEventListener('input', applyClientFilters));
  applyClientFilters();

  
  const tabCampaigns = document.getElementById('tab-campaigns');
  const tabCoverage = document.getElementById('tab-coverage');
  const panelCampaigns = document.getElementById('section-activities');
  const panelCoverage = document.getElementById('section-coverage');
  function activateTab(name){
    if (name === 'campaigns'){
      tabCampaigns.classList.add('bg-bf1-red','text-white');
      tabCoverage.classList.remove('bg-bf1-red','text-white');
      panelCampaigns.classList.remove('hidden');
      panelCoverage.classList.add('hidden');
    } else {
      tabCoverage.classList.add('bg-bf1-red','text-white');
      tabCampaigns.classList.remove('bg-bf1-red','text-white');
      panelCampaigns.classList.add('hidden');
      panelCoverage.classList.remove('hidden');
    }
  }
  tabCampaigns.addEventListener('click', () => activateTab('campaigns'));
  tabCoverage.addEventListener('click', () => activateTab('coverage'));
  activateTab('campaigns');

  
  const rowsCoverage = Array.from(document.querySelectorAll('#coverage-table tbody tr'));
  function applyCoverageFilters(){
    const q = (qInput.value||'').toLowerCase();
    rowsCoverage.forEach(r => {
      const title = (r.getAttribute('data-title')||'').toLowerCase();
      const contact = (r.getAttribute('data-contact')||'').toLowerCase();
      const okQ = !q || title.includes(q) || contact.includes(q);
      r.style.display = okQ ? '' : 'none';
    });
  }
  qInput.addEventListener('input', applyCoverageFilters);
  applyCoverageFilters();
</script>
{% endblock %}

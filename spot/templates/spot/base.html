{% load static %}
<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}BF1 - Gestion Publicitaire{% endblock %}</title>

    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'favicon-16x16.png' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'apple-touch-icon.png' %}">
    <link rel="shortcut icon" href="{% static 'favicon.ico' %}">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome (icônes) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'bf1-red': '#dc2626',
              'bf1-red-dark': '#b91c1c',
              'bf1-red-light': '#fee2e2',
              'bf1-gray': '#1f2937',
              'bf1-gray-dark': '#111827'
            },
          },
          fontFamily: {
            montserrat: ['Montserrat', 'sans-serif'],
            poppins: ['Poppins', 'sans-serif'],
          }
        }
      }
    </script>

    <!-- Styles additionnels pour utilitaires projet -->
    <style>
      .font-montserrat { font-family: 'Montserrat', sans-serif; }
      .font-poppins { font-family: 'Poppins', sans-serif; }
      .bf1-shadow { box-shadow: 0 10px 25px -10px rgba(0,0,0,0.25); }
      .bf1-hover { transition: transform .15s ease, box-shadow .15s ease; }
      .bf1-hover:hover { transform: translateY(-1px); box-shadow: 0 12px 32px -12px rgba(0,0,0,0.3); }
      :root{--bf1-brand:#dc2626;--bf1-brand-dark:#b91c1c;--bf1-ring:rgba(220,38,38,.28);--bf1-shadow-soft:0 10px 28px -18px rgba(0,0,0,.35);--bf1-shadow-deep:0 18px 46px -22px rgba(0,0,0,.45);--bf1-shadow-brand:0 18px 42px -24px rgba(220,38,38,.65)}
      .bf1-ui :where(a,button,[role="button"],input,select,textarea){transition:color .2s ease-out,background-color .2s ease-out,border-color .2s ease-out,opacity .2s ease-out,transform .3s ease-out,box-shadow .3s ease-out,filter .3s ease-out}
      .bf1-ui :where(a,button,[role="button"],input,select,textarea):focus-visible{outline:none;box-shadow:0 0 0 3px var(--bf1-ring)}
      .bf1-ui :where(button,[role="button"],input[type="submit"],input[type="button"]):active{transform:scale(.98)}
      @media (hover:hover){
        .bf1-ui :where(button,[role="button"],a,input[type="submit"],input[type="button"]):not([disabled]):hover{filter:saturate(1.03)}
        .bf1-ui :where(button,a,input[type="submit"]).bg-bf1-red.text-white:not([disabled]):hover{transform:translateY(-1px);box-shadow:var(--bf1-shadow-brand);filter:saturate(1.06) brightness(1.02)}
        .bf1-ui :where(button,a,input[type="submit"]).bg-gray-800.text-white:not([disabled]):hover{transform:translateY(-1px);box-shadow:var(--bf1-shadow-soft)}
        .bf1-ui :where(.bf1-hover,.bf1-shadow):hover{box-shadow:var(--bf1-shadow-deep)}
      }
      .bf1-page-enter{opacity:0;transition:opacity .3s ease-out}
      body.bf1-loaded .bf1-page-enter{opacity:1}
      .bf1-reveal{opacity:0;transform:translateY(14px);transition:opacity .45s ease-out,transform .45s cubic-bezier(0.22,1,0.36,1);transition-delay:calc(var(--bf1-reveal-delay, 0) * 1ms);will-change:opacity,transform}
      .bf1-reveal.is-inview{opacity:1;transform:none}
      .bf1-cta{position:relative;overflow:hidden;transform-origin:center;transition:transform .3s ease-out,box-shadow .3s ease-out,filter .3s ease-out,background-color .2s ease-out,color .2s ease-out,border-color .2s ease-out}
      .bf1-cta::after{content:'';position:absolute;inset:-40%;background:radial-gradient(circle at var(--bf1-rx,30%) var(--bf1-ry,30%),rgba(255,255,255,.35),transparent 55%);opacity:0;transition:opacity .3s ease-out;pointer-events:none}
      @media (hover:hover){
        .bf1-cta:hover{transform:translateY(-2px) scale(1.03);box-shadow:var(--bf1-shadow-brand)}
        .bf1-cta:hover::after{opacity:1}
      }
      .bf1-cta:active{transform:translateY(0) scale(.99);filter:brightness(.96) saturate(1.02)}
      .bf1-dropdown{opacity:0;transform:translateY(8px) scale(.98);pointer-events:none;visibility:hidden;transition:opacity .15s ease,transform .18s ease,filter .18s ease}
      .bf1-dropdown.is-open{opacity:1;transform:translateY(0) scale(1);pointer-events:auto;visibility:visible}
      html, body { max-width: 100%; overflow-x: hidden; }
      img, video, canvas, svg { max-width: 100%; height: auto; }
      pre, code { white-space: pre-wrap; word-break: break-word; }
      .bf1-ui :where(.flex,.inline-flex) > *{min-width:0}
      .bf1-ui :where(.grid) > *{min-width:0}
      .bf1-ui :where(h1,h2,h3,h4,h5,h6,p,a,span,li,td,th,div){overflow-wrap:anywhere;word-wrap:break-word;word-break:break-word}
      .u-min-0{min-width:0}
      .u-fit{max-width:100%;max-height:100%;overflow:hidden}
      .u-ellipsis{min-width:0;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
      .u-clamp-2{min-width:0;max-width:100%;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;overflow:hidden}
      .u-clamp-3{min-width:0;max-width:100%;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:3;overflow:hidden}
      .u-fluid-xs{font-size:clamp(.72rem,1.2vw,.82rem)}
      .u-fluid-sm{font-size:clamp(.82rem,1.6vw,.95rem)}
      .u-fluid-md{font-size:clamp(.95rem,2.2vw,1.1rem)}
      @media (max-width: 640px){.u-clamp-2{-webkit-line-clamp:3}.u-fluid-md{font-size:clamp(.92rem,4.2vw,1.05rem)}}

      /* Battement de cœur: légèrement plus lent (durée 1.2s) */
      @keyframes bf1-heartbeat {
        0%   { transform: scale(1); opacity: 1; }
        12%  { transform: scale(1.06); opacity: 0.95; }
        24%  { transform: scale(1); opacity: 1; }
        38%  { transform: scale(1.04); opacity: 0.96; }
        60%  { transform: scale(1); opacity: 1; }
        100% { transform: scale(1); opacity: 1; }
      }
      .heart-text {
        animation: bf1-heartbeat 1.2s ease-in-out infinite;
        transform-origin: center;
        will-change: transform, opacity;
      }

      /* Apparition élégante (faufillement) */
      @keyframes bf1-elegant-appear {
        0%   { opacity: 0; transform: translateY(10px) scale(0.98); }
        50%  { opacity: 0.6; transform: translateY(4px) scale(0.995); }
        100% { opacity: 1; transform: translateY(0) scale(1); }
      }
      .elegant-appear {
        animation: bf1-elegant-appear 1.4s ease both;
        will-change: opacity, transform;
      }

      /* Marquee lisse (défilement continu horizontal) */
      .bf1-marquee-container { overflow: hidden; position: relative; }
      .bf1-marquee-track {
        display: inline-flex;
        align-items: center;
        gap: 1.25rem;
        white-space: nowrap;
        will-change: transform;
        animation: bf1-marquee-left 22s linear infinite;
      }
      .bf1-marquee-item { display: inline-block; }
      .bf1-marquee-sep { opacity: 0.35; }
      @keyframes bf1-marquee-left { from { transform: translateX(0); } to { transform: translateX(-50%); } }

      /* Fallback accessibilité */
      @media (prefers-reduced-motion: reduce) {
        .heart-text, .elegant-appear, .bf1-marquee-track { animation: none; opacity: 1; transform: none; }
        .bf1-page-enter, .bf1-reveal, .bf1-cta { transition: none !important; transform: none !important; }
        .bf1-reveal { opacity: 1; }
        body.bf1-loaded .bf1-page-enter { opacity: 1; }
        .bf1-cta::after { display: none; }
      }
    </style>

    {% block extra_head %}{% endblock %}
</head>
<body class="bf1-ui min-h-full bg-gray-50 text-gray-900 antialiased font-poppins">
    <!-- Barre supérieure -->
    <header class="fixed top-0 left-0 right-0 bg-white border-b z-40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-14 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <button id="menu-toggle" type="button" aria-label="Ouvrir le menu" aria-expanded="false" aria-controls="mobile-menu" class="md:hidden p-2 rounded hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-bf1-red">
            <i class="fas fa-bars"></i>
          </button>
          <a href="{% url 'home' %}" class="flex items-center gap-2">
            <img src="{% static 'logo_bf1.jpg' %}" alt="BF1" class="w-7 h-7 rounded" />
            <span class="font-semibold">Gestion Publicitaire</span>
          </a>
        </div>
        <nav class="hidden md:flex items-center gap-6 text-sm">
          <a href="{% url 'home' %}" class="inline-flex items-center gap-1 font-medium text-gray-700 hover:text-bf1-red">
            <i class="fas fa-home text-bf1-red"></i> <span>Accueil</span>
          </a>
          
          {% if user.role == 'client' %}
          <div class="relative group">
            <button type="button" aria-expanded="false" class="inline-flex items-center gap-1 font-semibold text-gray-700 hover:text-bf1-red">
              <i class="fas fa-question-circle text-bf1-red"></i> <span>Aide</span> <i class="fas fa-chevron-down text-xs"></i>
            </button>
            <div class="bf1-dropdown absolute left-0 mt-2 w-56 bg-white border rounded shadow-lg z-50">
              <a href="{% url 'advisory_wizard' %}" class="block px-3 py-2 hover:bg-gray-50">Conseils</a>
              <a href="{% url 'guides_list' %}" class="block px-3 py-2 hover:bg-gray-50">Guides</a>
              <a href="{% url 'inspiration' %}" class="block px-3 py-2 hover:bg-gray-50">Inspiration</a>
              <a href="{% url 'contact_advisor' %}" class="block px-3 py-2 hover:bg-gray-50">Contact</a>
              <a href="{% url 'pricing_overview' %}" class="block px-3 py-2 hover:bg-gray-50">Tarifs</a>
            </div>
          </div>
          <div class="relative group">
            <button type="button" aria-expanded="false" class="inline-flex items-center gap-1 font-semibold text-gray-700 hover:text-bf1-red">
              <i class="fas fa-pencil-alt text-bf1-red"></i> <span>Créer</span> <i class="fas fa-chevron-down text-xs"></i>
            </button>
            <div class="bf1-dropdown absolute left-0 mt-2 w-56 bg-white border rounded shadow-lg z-50">
              <a href="{% url 'campaign_spot_create' %}" class="block px-3 py-2 hover:bg-gray-50">Campagne/Spot</a>
              <a href="{% url 'coverage_request_create' %}" class="block px-3 py-2 hover:bg-gray-50">Demande de couverture</a>
            </div>
          </div>
          {% endif %}
          <div class="relative group">
            <button type="button" aria-expanded="false" class="inline-flex items-center gap-1 font-semibold text-gray-700 hover:text-bf1-red">
              <i class="fas fa-folder-open text-bf1-red"></i> <span>Mes services</span> <i class="fas fa-chevron-down text-xs"></i>
            </button>
            <div class="bf1-dropdown absolute left-0 mt-2 w-56 bg-white border rounded shadow-lg z-50">
              <a href="{% url 'campaign_list' %}" class="block px-3 py-2 hover:bg-gray-50">Historique</a>
              <a href="{% url 'spot_list' %}" class="block px-3 py-2 hover:bg-gray-50">Mes spots</a>
              <a href="{% url 'broadcast_grid' %}" class="block px-3 py-2 hover:bg-gray-50">Mes programmations</a>
              <a href="{% url 'correspondence_list' %}" class="block px-3 py-2 hover:bg-gray-50">Correspondance</a>
              <a href="{% url 'report_overview' %}" class="block px-3 py-2 hover:bg-gray-50">Mes rapports</a>
            </div>
          </div>
          {% if user.is_authenticated %}
          <a href="{% url 'notifications' %}" class="inline-flex items-center gap-1 font-medium text-gray-700 hover:text-bf1-red">
            <i class="fas fa-bell text-bf1-red"></i> <span>Notifications</span>
            {% if NOTIFS_UNREAD_COUNT and NOTIFS_UNREAD_COUNT > 0 %}
              <span class="ml-1 text-[10px] px-1.5 py-0.5 rounded-full bg-bf1-red text-white">{{ NOTIFS_UNREAD_COUNT }}</span>
            {% endif %}
          </a>
          {% endif %}
          <div class="relative group">
            <button type="button" aria-expanded="false" class="inline-flex items-center gap-1 font-semibold text-gray-700 hover:text-bf1-red">
              <i class="fas fa-user text-bf1-red"></i> <span>Profil</span> <i class="fas fa-chevron-down text-xs"></i>
            </button>
            <div class="bf1-dropdown absolute right-0 mt-2 w-44 bg-white border rounded shadow-lg z-50">
              {% if user.is_authenticated %}
            <a href="{% url 'profile' %}" class="block px-3 py-2 hover:bg-gray-50">Mon profil</a>
            {% if user.role == 'admin' %}
            <a href="{% url 'admin_dashboard' %}" class="block px-3 py-2 hover:bg-gray-50">Administration</a>
            {% endif %}
            <a href="{% url 'logout' %}" class="block px-3 py-2 hover:bg-gray-50">Déconnexion</a>
              {% else %}
                <a href="{% url 'login' %}" class="block px-3 py-2 hover:bg-gray-50">Connexion</a>
                <a href="{% url 'register' %}" class="block px-3 py-2 hover:bg-gray-50">Créer un compte</a>
              {% endif %}
            </div>
          </div>
        </nav>
      </div>
    </header>

    <!-- Overlay du menu -->
    <div id="menu-overlay" class="fixed inset-0 bg-black/30 z-30 hidden"></div>

    <!-- Menu latéral -->
    <aside id="mobile-menu" class="fixed inset-y-0 left-0 w-80 max-w-[85vw] bg-white z-40 shadow-xl transform -translate-x-full transition-transform duration-200 overflow-y-auto">
      <div class="px-4 py-4 flex items-center justify-between border-b">
        <div class="flex items-center gap-2">
            <img src="{% static 'logo_bf1.jpg' %}" alt="BF1" class="w-8 h-8 rounded" />
          <div>
            <div class="font-semibold">Gestion Publicitaire</div>
          <div class="text-xs text-gray-500">BF1</div>
          </div>
        </div>
        <button id="menu-close" type="button" aria-label="Fermer" class="p-2 rounded hover:bg-gray-100">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <nav id="mobile-nav" class="px-4 py-3 text-sm">
        <div class="space-y-2">
          <div class="border-b">
            <button type="button"
                    class="w-full flex items-center justify-between px-3 py-3 rounded hover:bg-gray-100 font-semibold text-gray-900"
                    data-acc-toggle
                    aria-expanded="false"
                    aria-controls="acc-profile">
              <span class="flex items-center gap-3"><i class="fas fa-user text-bf1-red"></i> Profil</span>
              <i class="fas fa-chevron-down text-gray-500 transition-transform duration-200" data-acc-icon></i>
            </button>
            <div id="acc-profile" class="max-h-0 overflow-hidden transition-[max-height] duration-200 ease-in-out" data-acc-panel>
              <div class="pl-10 pr-2 pb-2 space-y-1">
                {% if user.is_authenticated %}
                <a href="{% url 'profile' %}" class="flex items-center gap-3 px-3 py-3 rounded hover:bg-gray-100 font-medium text-gray-800">
                  <i class="fas fa-user text-bf1-red"></i> Mon profil
                </a>
                <a href="{% url 'campaign_list' %}" class="flex items-center gap-3 px-3 py-3 rounded hover:bg-gray-100 font-medium text-gray-800">
                  <i class="fas fa-clock text-bf1-red"></i> Historique
                </a>
                {% if user.role == 'admin' %}
                <a href="{% url 'admin_dashboard' %}" class="flex items-center gap-3 px-3 py-3 rounded hover:bg-gray-100 font-medium text-gray-800">
                  <i class="fas fa-tachometer-alt text-bf1-red"></i> Console admin
                </a>
                {% endif %}
                {% else %}
                <a href="{% url 'login' %}" class="flex items-center gap-3 px-3 py-3 rounded hover:bg-gray-100 font-medium text-gray-800">
                  <i class="fas fa-sign-in-alt text-bf1-red"></i> Connexion
                </a>
                <a href="{% url 'register' %}" class="flex items-center gap-3 px-3 py-3 rounded hover:bg-gray-100 font-medium text-gray-800">
                  <i class="fas fa-user-plus text-bf1-red"></i> Créer un compte
                </a>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="border-b">
            <button type="button"
                    class="w-full flex items-center justify-between px-3 py-3 rounded hover:bg-gray-100 font-semibold text-gray-900"
                    data-acc-toggle
                    aria-expanded="false"
                    aria-controls="acc-content">
              <span class="flex items-center gap-3"><i class="fas fa-folder-open text-bf1-red"></i> Contenu</span>
              <i class="fas fa-chevron-down text-gray-500 transition-transform duration-200" data-acc-icon></i>
            </button>
            <div id="acc-content" class="max-h-0 overflow-hidden transition-[max-height] duration-200 ease-in-out" data-acc-panel>
              <div class="pl-10 pr-2 pb-2 space-y-1">
                <a href="{% url 'home' %}" class="flex items-center gap-3 px-3 py-3 rounded hover:bg-gray-100 font-medium text-gray-800">
                  <i class="fas fa-home text-bf1-red"></i> Accueil
                </a>
                {% if user.is_authenticated %}
                <a href="{% url 'notifications' %}" class="flex items-center gap-3 px-3 py-3 rounded hover:bg-gray-100 font-medium text-gray-800">
                  <i class="fas fa-bell text-bf1-red"></i> Notifications
                  {% if NOTIFS_UNREAD_COUNT and NOTIFS_UNREAD_COUNT > 0 %}
                    <span class="ml-auto text-[10px] px-1.5 py-0.5 rounded-full bg-bf1-red text-white">{{ NOTIFS_UNREAD_COUNT }}</span>
                  {% endif %}
                </a>
                {% endif %}
                <a href="{% url 'spot_list' %}" class="flex items-center gap-3 px-3 py-3 rounded hover:bg-gray-100 font-medium text-gray-800">
                  <i class="fas fa-map-marker-alt text-bf1-red"></i> Les spots
                </a>
                <a href="{% url 'broadcast_grid' %}" class="flex items-center gap-3 px-3 py-3 rounded hover:bg-gray-100 font-medium text-gray-800">
                  <i class="fas fa-calendar text-bf1-red"></i> Mes programmations
                </a>
                {% if user.is_authenticated and user.role == 'admin' %}
                <a href="{% url 'admin_campaign_list' %}" class="flex items-center gap-3 px-3 py-3 rounded hover:bg-gray-100 font-medium text-gray-800">
                  <i class="fas fa-bullhorn text-bf1-red"></i> Campagnes
                </a>
                <a href="{% url 'admin_coverage_list' %}" class="flex items-center gap-3 px-3 py-3 rounded hover:bg-gray-100 font-medium text-gray-800">
                  <i class="fas fa-map text-bf1-red"></i> Couvertures
                </a>
                {% elif user.is_authenticated %}
                <a href="{% url 'campaign_list' %}" class="flex items-center gap-3 px-3 py-3 rounded hover:bg-gray-100 font-medium text-gray-800">
                  <i class="fas fa-bullhorn text-bf1-red"></i> Campagnes
                </a>
                <a href="{% url 'coverage_request_create' %}" class="flex items-center gap-3 px-3 py-3 rounded hover:bg-gray-100 font-medium text-gray-800">
                  <i class="fas fa-map text-bf1-red"></i> Couvertures
                </a>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="border-b">
            <button type="button"
                    class="w-full flex items-center justify-between px-3 py-3 rounded hover:bg-gray-100 font-semibold text-gray-900"
                    data-acc-toggle
                    aria-expanded="false"
                    aria-controls="acc-interactions">
              <span class="flex items-center gap-3"><i class="fas fa-comments text-bf1-red"></i> Interactions</span>
              <i class="fas fa-chevron-down text-gray-500 transition-transform duration-200" data-acc-icon></i>
            </button>
            <div id="acc-interactions" class="max-h-0 overflow-hidden transition-[max-height] duration-200 ease-in-out" data-acc-panel>
              <div class="pl-10 pr-2 pb-2 space-y-1">
                <a href="{% url 'correspondence_list' %}" class="flex items-center gap-3 px-3 py-3 rounded hover:bg-gray-100 font-medium text-gray-800">
                  <i class="fas fa-comments text-bf1-red"></i> Correspondance
                </a>
                <a href="{% url 'report_overview' %}" class="flex items-center gap-3 px-3 py-3 rounded hover:bg-gray-100 font-medium text-gray-800">
                  <i class="fas fa-chart-line text-bf1-red"></i> Mes rapports
                </a>
              </div>
            </div>
          </div>
        </div>

        {% if user.is_authenticated %}
          <div class="mt-3">
            <a href="{% url 'logout' %}" class="flex items-center gap-3 px-3 py-3 rounded hover:bg-gray-100 font-semibold text-gray-900">
              <i class="fas fa-sign-out-alt text-bf1-red"></i> Déconnexion
            </a>
          </div>
        {% endif %}
      </nav>
    </aside>

    <!-- Contenu principal -->
    <main class="pt-16 bf1-page-enter" data-bf1-reveal-root>
      {% block content %}{% endblock %}
    </main>

    {% block footer %}
    <footer class="border-t bg-white py-4 text-center text-sm text-gray-500">
      © {% now "Y" %} BF1
    </footer>
    {% endblock %}

    <!-- Widgets globaux -->
    {% include 'spot/includes/whatsapp_widget.html' %}
    {% include 'spot/includes/chatbot_widget.html' %}

    <!-- Scripts de base (menu) -->
    <script>
      (function(){
        const toggle = document.getElementById('menu-toggle');
        const closeBtn = document.getElementById('menu-close');
        const overlay = document.getElementById('menu-overlay');
        const menu = document.getElementById('mobile-menu');
        let resetAccordion = null;
        const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        const revealRoot = document.querySelector('main[data-bf1-reveal-root]');
        window.requestAnimationFrame(() => { document.body.classList.add('bf1-loaded'); });

        const open = () => {
          if (resetAccordion) resetAccordion();
          menu.classList.remove('-translate-x-full');
          overlay.classList.remove('hidden');
          document.body.classList.add('overflow-hidden');
          if (toggle) toggle.setAttribute('aria-expanded', 'true');
        };
        const close = () => {
          menu.classList.add('-translate-x-full');
          overlay.classList.add('hidden');
          document.body.classList.remove('overflow-hidden');
          if (toggle) toggle.setAttribute('aria-expanded', 'false');
          if (resetAccordion) resetAccordion();
        };
        if (toggle) toggle.addEventListener('click', open);
        if (closeBtn) closeBtn.addEventListener('click', close);
        if (overlay) overlay.addEventListener('click', close);
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });

        const nav = document.getElementById('mobile-nav');
        if (nav) {
          nav.querySelectorAll('a[href]').forEach((a) => {
            a.addEventListener('click', () => close());
          });

          const toggles = Array.from(nav.querySelectorAll('[data-acc-toggle]'));
          const setExpanded = (btn, expanded) => {
            const panelId = btn.getAttribute('aria-controls');
            const panel = panelId ? document.getElementById(panelId) : null;
            const icon = btn.querySelector('[data-acc-icon]');
            btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
            if (icon) icon.classList.toggle('rotate-180', expanded);
            if (!panel) return;
            if (expanded) {
              panel.style.maxHeight = panel.scrollHeight + 'px';
            } else {
              panel.style.maxHeight = '0px';
            }
          };
          const closeOthers = (exceptBtn) => {
            toggles.forEach((b) => {
              if (b !== exceptBtn) setExpanded(b, false);
            });
          };
          resetAccordion = () => {
            toggles.forEach((b) => setExpanded(b, false));
          };
          resetAccordion();
          toggles.forEach((btn) => {
            btn.addEventListener('click', () => {
              const expanded = btn.getAttribute('aria-expanded') === 'true';
              if (!expanded) closeOthers(btn);
              setExpanded(btn, !expanded);
            });
          });
          window.addEventListener('resize', () => {
            toggles.forEach((btn) => {
              if (btn.getAttribute('aria-expanded') !== 'true') return;
              const panelId = btn.getAttribute('aria-controls');
              const panel = panelId ? document.getElementById(panelId) : null;
              if (panel) panel.style.maxHeight = panel.scrollHeight + 'px';
            });
          });
        }

        // Dropdowns du header: ouverture au survol + fermeture intelligente
        const prefersHover = window.matchMedia && window.matchMedia('(hover: hover)').matches;
        const headerDropdowns = Array.from(document.querySelectorAll('header nav .relative.group'));
        const getButton = (wrap) => wrap ? wrap.querySelector(':scope > button') : null;
        const getMenu = (wrap) => wrap ? wrap.querySelector(':scope > .bf1-dropdown') : null;
        const closeAll = (exceptWrap) => {
          headerDropdowns.forEach((wrap) => {
            if (exceptWrap && wrap === exceptWrap) return;
            const btn = getButton(wrap);
            const menu = getMenu(wrap);
            if (!menu) return;
            menu.classList.remove('is-open');
            if (btn) btn.setAttribute('aria-expanded', 'false');
          });
        };

        headerDropdowns.forEach((wrap) => {
          const btn = getButton(wrap);
          const menu = getMenu(wrap);
          if (!btn || !menu) return;

          let closeTimer = null;
          const open = () => {
            if (closeTimer) window.clearTimeout(closeTimer);
            closeAll(wrap);
            menu.classList.add('is-open');
            btn.setAttribute('aria-expanded', 'true');
          };
          const scheduleClose = () => {
            if (closeTimer) window.clearTimeout(closeTimer);
            closeTimer = window.setTimeout(() => {
              menu.classList.remove('is-open');
              btn.setAttribute('aria-expanded', 'false');
            }, 300);
          };

          if (prefersHover) {
            btn.addEventListener('mouseenter', open);
            btn.addEventListener('mouseleave', scheduleClose);
            menu.addEventListener('mouseenter', open);
            menu.addEventListener('mouseleave', scheduleClose);
          }

          btn.addEventListener('click', (e) => {
            e.preventDefault();
            if (!menu.classList.contains('is-open')) {
              open();
            } else {
              menu.classList.remove('is-open');
              btn.setAttribute('aria-expanded', 'false');
            }
          });
        });

        document.addEventListener('click', (e) => {
          if (headerDropdowns.some((wrap) => wrap.contains(e.target))) return;
          closeAll(null);
        });

        const isButtonLike = (el) => {
          if (!el || !el.classList) return false;
          if (el.closest('header') || el.closest('aside') || el.closest('footer')) return false;
          const cls = Array.from(el.classList);
          const hasPadding = cls.some((c) => c.startsWith('px-') || c.startsWith('py-') || c.startsWith('p-'));
          const hasRounded = cls.some((c) => c.startsWith('rounded'));
          const hasBg = cls.some((c) => c.startsWith('bg-') || c.startsWith('from-') || c.startsWith('to-') || c.startsWith('via-') || c.includes('bg-gradient'));
          const hasBorderShadow = cls.some((c) => c.startsWith('border') || c.startsWith('shadow'));
          return hasRounded && hasPadding && (hasBg || hasBorderShadow);
        };
        const enhanceCTAs = () => {
          const scope = revealRoot || document;
          const nodes = Array.from(scope.querySelectorAll('a,button,input[type="submit"],input[type="button"]'));
          nodes.forEach((el) => {
            if (!isButtonLike(el)) return;
            el.classList.add('bf1-cta');
            const setPos = (e) => {
              const rect = el.getBoundingClientRect();
              const x = Math.max(0, Math.min(100, ((e.clientX - rect.left) / Math.max(1, rect.width)) * 100));
              const y = Math.max(0, Math.min(100, ((e.clientY - rect.top) / Math.max(1, rect.height)) * 100));
              el.style.setProperty('--bf1-rx', x.toFixed(2) + '%');
              el.style.setProperty('--bf1-ry', y.toFixed(2) + '%');
            };
            el.addEventListener('pointermove', setPos, { passive: true });
            el.addEventListener('mouseenter', setPos, { passive: true });
          });
        };
        const initReveal = () => {
          if (!revealRoot) return;
          const direct = Array.from(revealRoot.children).filter((n) => n && n.nodeType === 1);
          direct.forEach((el, idx) => {
            el.classList.add('bf1-reveal');
            el.style.setProperty('--bf1-reveal-delay', String(Math.min(idx * 70, 420)));
          });
          const extras = Array.from(revealRoot.querySelectorAll('[data-bf1-reveal]'));
          extras.forEach((el) => el.classList.add('bf1-reveal'));
          const targets = Array.from(new Set([...direct, ...extras]));
          if (prefersReduced) {
            targets.forEach((el) => el.classList.add('is-inview'));
            return;
          }
          if (!('IntersectionObserver' in window)) {
            targets.forEach((el) => el.classList.add('is-inview'));
            return;
          }
          const obs = new IntersectionObserver(
            (entries) => {
              entries.forEach((entry) => {
                if (!entry.isIntersecting) return;
                entry.target.classList.add('is-inview');
                obs.unobserve(entry.target);
              });
            },
            { root: null, rootMargin: '0px 0px -10% 0px', threshold: 0.05 }
          );
          targets.forEach((el) => obs.observe(el));
        };

        enhanceCTAs();
        initReveal();
      })();
    </script>

    {% block scripts %}{% endblock %}
    {% block extra_js %}{% endblock %}

    {% if messages %}
    <script>
      window.__messages__ = [
        {% for message in messages %}
          { text: "{{ message|escapejs }}", level: "{{ message.tags|default:'info' }}" },
        {% endfor %}
      ];
    </script>
    {% endif %}
    <div id="toast-container" class="fixed z-50 top-4 left-4 right-4 sm:left-auto sm:right-4 space-y-3" aria-live="polite" role="status"></div>
    <script>
      (function(){
        const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        const msgs = window.__messages__ || [];
        const container = document.getElementById('toast-container');
        const levelClasses = {
          success: 'bg-green-600 text-white',
          error: 'bg-red-600 text-white',
          warning: 'bg-yellow-500 text-gray-900',
          info: 'bg-gray-800 text-white'
        };
        function addToast(text, level){
          if(!container) return;
          const el = document.createElement('div');
          el.className = 'shadow-lg rounded-lg px-4 py-3 flex items-start gap-3 w-full sm:w-96 max-w-full ml-auto break-words ' + (levelClasses[level] || levelClasses.info);
          el.setAttribute('role','alert');
          el.innerHTML = '<span class="sr-only">Notification:</span><div class="flex-1">'+ text +'</div><button type="button" aria-label="Fermer" class="ml-3 text-white/80 hover:text-white">✕</button>';
          const closeBtn = el.querySelector('button');
          closeBtn.addEventListener('click', function(){ el.remove(); });
          container.appendChild(el);
          if(!prefersReduced){
            el.style.opacity = '0'; el.style.transform = 'translateY(-6px)';
            requestAnimationFrame(function(){ el.style.transition = 'opacity .2s ease, transform .2s ease'; el.style.opacity='1'; el.style.transform='none'; });
          }
          setTimeout(function(){
            if(!el.parentNode) return;
            if(!prefersReduced){ el.style.opacity='0'; el.style.transform='translateY(-6px)'; setTimeout(function(){ el.remove(); }, 200); }
            else { el.remove(); }
          }, 4000);
        }
        msgs.forEach(function(m){ addToast(m.text, m.level); });
      })();
    </script>
</body>
</html>
